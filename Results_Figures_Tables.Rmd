---
title: "Figure and table"
author: "peyman"
date: "2024-03-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Library   
```{r libraries, include=FALSE}
#library(kableExtra)
options(knitr.table.format = "latex")
library(readr)
library(data.table)
library(MASS)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpointdensity)
library(ggpubr)
library(igraph)
library(fpc)
library(grid)
library(gridExtra)
library(reshape2)
library(visNetwork)
library(pheatmap)
library(umap)
library(Rtsne)
library(viridis)
library(viridisLite)
library(bio3d)
library(caret)
library(e1071)
library(randomForest)
library(seqinr)
library(geometry)
library(ape)
library(colorspace)
library(dendextend)
library(dynamicTreeCut)
library(caret)
library(ggtree)
library(phangorn)
library(tanggle)
library(stringr)
library(protr)
library(proxy)
library(class)
library(readxl)
library(ggh4x)
library(mclust)
library(googledrive)
```

# Figures

## Fig 1

```{r Fig 1}
source('Functions.R')
# ----------------------------------------------------
# ************** total energy 40 and 95
df_tot <- readRDS('manuscript/fig_data/df_total_energy.rds')
df_tot$data <- ifelse(df_tot$data=='Astral 40','ASTRAL40','ASTRAL95')
AB <- ggplot(df_tot, aes(seq/2000,str/1000))+
       geom_pointdensity(adjust = .1,alpha=.3,show.legend = T)+
       geom_smooth(method = 'glm',col='red')+
       stat_cor(method = "pearson", size=5, color = "red", geom = "label") +
       scale_color_viridis()+facet_wrap(vars(data))+
       theme_bw(base_line_size = .3)+
       xlab('Total energy (sequence)')+ylab('Total energy (structure)')+
  mytheme()
# ************** distance 40 and 95
df_dis40<-readRDS('manuscript/fig_data/dis_40_manhat.rds')
df_dis95<-readRDS('manuscript/fig_data/dis_95_manhat.rds')
df_dis <- rbind(df_dis40, df_dis95)
df_dis$data <- ifelse(df_dis$data=='Astral 40','ASTRAL40','ASTRAL95')

CD <- ggplot(df_dis, aes(dis_seq,dis_str))+
       geom_pointdensity(adjust = .1,alpha=.3,show.legend = T)+
       geom_smooth(method = 'glm',col='red')+
       stat_cor(method = "pearson", size=5, color = "red", geom = "label") +
       scale_color_viridis()+facet_wrap(vars(data))+
       theme_bw(base_line_size = .3)+
       xlab('Distance (CPE)')+ylab('Distance (SPE)')+
       mytheme()

ggarrange(NULL,
    AB, NULL,CD, ncol = 1,
    heights = c(0.09, 1, 0.17, 1),
    labels = c('',"A", "", "B"),
    font.label = list(size = 30),    # color = "red"
    hjust = -.5,vjust = 0
    )

# save FIG1.pdf 10x9
```

## Fig 2

```{r Fig 2}
source('Functions.R')
# ----------------------------------------------------
df_tot <- readRDS('manuscript/fig_data/df_total_energy.rds')
df_tot <- df_tot[df_tot$class%in%c('a','b','c','d'),]
df_tot$class[df_tot$class=='a']<-'All_alpha'
df_tot$class[df_tot$class=='b']<-'All_beta'
df_tot$class[df_tot$class=='c']<-'alpha/beta'
df_tot$class[df_tot$class=='d']<-'alpha+beta'
df_tot$data <- ifelse(df_tot$data=='Astral 40','ASTRAL40','ASTRAL95')

AB <- ggplot(df_tot,aes(class,str/length,fill=class))+
  geom_boxplot(outlier.alpha = .01)+
  facet_wrap(vars(data))+
  xlab('')+ylab('Total energy (structure)')+
  coord_cartesian(ylim = c(-15, -4))+
  mytheme()+theme(legend.title = element_blank(),
               axis.text.x = element_blank())

CD <- ggplot(df_tot,aes(class,seq/(2*length),fill=class))+
  geom_boxplot(outlier.alpha = .1)+
  facet_wrap(vars(data))+
  xlab('')+ylab('Total energy (sequence)')+
  coord_cartesian(ylim = c(-15, -6))+
  mytheme()+theme(legend.title = element_blank(),
               axis.text.x = element_blank())


ggarrange(NULL,
    AB, NULL,CD, ncol = 1,
    heights = c(0.09, 1, 0.17, 1),
    labels = c('',"A", "", "B"),
    common.legend = T, legend = 'bottom',
    font.label = list(size = 30),    # color = "red"
    hjust = -.5,vjust = 0
    )
# save FIG2.pdf 10x9
```

## Fig 3

```{r Fig 3}
source('Functions.R')
# ----------------------------------------------------
load('manuscript/fig_data/UMPs.RData')
ump_df_str40$type <- ifelse(ump_df_str40$type=='Structure','SPE','CPE')
ump_df_seq40$type <- ifelse(ump_df_seq40$type=='Structure','SPE','CPE')
ump_df_str95$type <- ifelse(ump_df_str95$type=='Structure','SPE','CPE')
ump_df_seq95$type <- ifelse(ump_df_seq95$type=='Structure','SPE','CPE')

ump_df_str40$data <- ump_df_seq40$data <- 'ASTRAL40'

p1<-ggplot(ump_df_str40,aes(UMAP1, UMAP2, color= class)) +
  geom_point(alpha=.7,size=.5) + 
  #facet_grid(data ~ type)+xlab('')+ylab('')+
  mytheme()+scale_color_manual(values = c('green','magenta'))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 5)))

p2<-ggplot(ump_df_seq40,aes(UMAP1, UMAP2, color= class)) +
  geom_point(alpha=.7,size=.5) + 
  facet_grid( ~ type)+xlab('')+
  #facet_grid(data ~ type)+xlab('')+ylab('')+
  mytheme()+scale_color_manual(values = c('green','magenta'))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 5)))

p3<-ggplot(ump_df_str95,aes(UMAP1, UMAP2, color= class)) +
  geom_point(alpha=.7,size=.5) +
  facet_grid(rows = vars(data))+ylab('')+
  mytheme()+scale_color_manual(values = c('green','magenta'))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 5)))


p4<-ggplot(ump_df_seq95,aes(UMAP1, UMAP2, color= class)) +
  geom_point(alpha=.7,size=.5) + 
  #facet_grid(rows = vars(data))+ylab('')+
  mytheme()+scale_color_manual(values = c('green','magenta'))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 5)))

# ********
ggarrange(NULL,NULL,NULL,
          p2,NULL,p1,
          NULL,NULL,NULL,
          p4,NULL,p3,ncol = 3,nrow = 4,
          common.legend = T,
          labels = c('','','',
                     "A", "", "B",
                     '','','',
                     'C','','D'),
          font.label = list(size = 30),
          widths = c(1, 0.12, 1),
          heights = c(.1, 1, 0.12, 1),
          hjust = -.5,vjust = 0,legend = 'bottom')

# save FIG3.pdf 10x10
```

## Fig 4 A

```{r Fig 4 A}
source('Functions.R')
# ----------------------------------------------------
# ******** str40
df <- readRDS("Data/rds/E210.astral_40.rds")
df <- df[df$fold%in%c('a.100','a.104'),]
df <- df[!is.na(df$FF),]
df <- df[,c(6,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_str <- data.frame(data='Astral 40',type='SPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])

# ******** seq40
df <- readRDS("Data/rds/E210.seq_astral_40.rds")
df <- df[df$fold%in%c('a.100','a.104'),]
df <- df[!is.na(df$FF),]
df <- df[,c(6,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_seq <- data.frame(data='Astral 40',type='CPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])
z <- rbind(ump_df_str,ump_df_seq)
z$data <- 'ASTRAL40'
z$class <- ifelse(z$class=='a.100', 'a.100    ','a.104')

p1 <- ggplot(z,aes(UMAP1, UMAP2, color= class)) +
    geom_point(alpha=.7) + 
    facet_nested(~ data+type,independent = T,scales = T)+
  ylab('')+xlab('')+
  mytheme()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 3)))
# ---------------------
# ******** str95
df <- readRDS("Data/rds/E210.astral_95.rds")
df <- df[df$fold%in%c('a.100','a.104'),]
df <- df[!is.na(df$FF),]
df <- df[,c(6,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_str <- data.frame(data='Astral 95',type='SPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])

# ******** seq95
df <- readRDS("Data/rds/E210.seq_astral_95.rds")
df <- df[df$fold%in%c('a.100','a.104'),]
df <- df[!is.na(df$FF),]
df <- df[,c(6,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_seq <- data.frame(data='Astral 95',type='CPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])
z <- rbind(ump_df_str,ump_df_seq)
z$data <- 'ASTRAL95'
z$class <- ifelse(z$class=='a.100', 'a.100    ','a.104')


p2 <- ggplot(z,aes(UMAP1, UMAP2, color= class)) +
    geom_point(alpha=.7) + 
    facet_nested(~ data+type,independent = T,scales = T)+
  ylab('')+xlab('')+
  mytheme()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 3)))

A<-ggarrange(NULL,NULL,NULL,NULL,
             NULL,p1,NULL,p2,nrow = 2,ncol = 4,
          common.legend = T,legend = 'right',
          widths = c(.1,1, 0.0, 1),
          heights = c(.07,1),
          labels = c('','','','',
                     '',"A", "", ""),
  font.label = list(size = 30),
  hjust = .2,vjust = 0)
saveRDS(A,'manuscript/Fig4A.rds')
```

## Fig 4 B

```{r Fig 4 B}
source('Functions.R')
# ----------------------------------------------------
# ******** str40
df <- readRDS("Data/rds/E210.astral_40.rds")
df <- df[df$superfamily%in%c('a.29.2','a.29.3'),]
df <- df[!is.na(df$FF),]
df <- df[,c(7,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_str <- data.frame(data='Astral 40',type='SPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])

# ******** seq40
df <- readRDS("Data/rds/E210.seq_astral_40.rds")
df <- df[df$superfamily%in%c('a.29.2','a.29.3'),]
df <- df[!is.na(df$FF),]
df <- df[,c(7,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_seq <- data.frame(data='Astral 40',type='CPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])
z <- rbind(ump_df_str,ump_df_seq)
z$data <- 'ASTRAL40'
z$class <- ifelse(z$class=='a.29.2', 'a.29.2   ','a.29.3')

p1 <- ggplot(z,aes(UMAP1, UMAP2, color= class)) +
    geom_point(alpha=.7) + 
    facet_nested(~ data+type,independent = T,scales = T)+
  ylab('')+xlab('')+
  mytheme()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 3)))
# ---------------------
# ******** str95
df <- readRDS("Data/rds/E210.astral_95.rds")
df <- df[df$superfamily%in%c('a.29.2','a.29.3'),]
df <- df[!is.na(df$FF),]
df <- df[,c(7,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_str <- data.frame(data='Astral 95',type='SPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])

# ******** seq95
df <- readRDS("Data/rds/E210.seq_astral_95.rds")
df <- df[df$superfamily%in%c('a.29.2','a.29.3'),]
df <- df[!is.na(df$FF),]
df <- df[,c(7,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 30,
            min_dist = 0.1,
            input="dist")
ump_df_seq <- data.frame(data='Astral 95',type='CPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])
z <- rbind(ump_df_str,ump_df_seq)
z$data <- 'ASTRAL95'
z$class <- ifelse(z$class=='a.29.2', 'a.29.2   ','a.29.3')

p2 <- ggplot(z,aes(UMAP1, UMAP2, color= class)) +
    geom_point(alpha=.7) + 
    facet_nested(~ data+type,independent = T,scales = T)+
  ylab('')+xlab('')+
  mytheme()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 3)))

B <- ggarrange(NULL,NULL,NULL,NULL,
             NULL,p1,NULL,p2,nrow = 2,ncol = 4,
          common.legend = T,legend = 'right',
          widths = c(.1,1, 0.0, 1),
          heights = c(.07,1),
          labels = c('','','','',
                     '',"B", "", ""),
  font.label = list(size = 30),
  hjust = .2,vjust = 0)
saveRDS(B,'manuscript/Fig4B.rds')
```

## Fig 4 C

```{r Fig 4 C}
source('Functions.R')
# ----------------------------------------------------
# ******** str40
df <- readRDS("Data/rds/E210.astral_40.rds")
df <- df[df$family%in%c('a.25.1.0','a.25.1.2'),]
df <- df[!is.na(df$FF),]
df <- df[,c(8,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 10,
            min_dist = 0.1,
            input="dist")
ump_df_str <- data.frame(data='Astral 40',type='SPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])

# ******** seq40
df <- readRDS("Data/rds/E210.seq_astral_40.rds")
df <- df[df$family%in%c('a.25.1.0','a.25.1.2'),]
df <- df[!is.na(df$FF),]
df <- df[,c(8,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 10,
            min_dist = 0.1,
            input="dist")
ump_df_seq <- data.frame(data='Astral 40',type='CPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])
z <- rbind(ump_df_str,ump_df_seq)
z$data <- 'ASTRAl40'

p1 <- ggplot(z,aes(UMAP1, UMAP2, color= class)) +
    geom_point(alpha=.7) + 
    facet_nested(~ data+type,independent = T,scales = T)+
  ylab('')+xlab('')+
  mytheme()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 3)))
# ---------------------
# ******** str95
df <- readRDS("Data/rds/E210.astral_95.rds")
df <- df[df$family%in%c('a.25.1.0','a.25.1.2'),]
df <- df[!is.na(df$FF),]
df <- df[,c(8,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 10,
            min_dist = 0.1,
            input="dist")
ump_df_str <- data.frame(data='Astral 95',type='SPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])

# ******** seq95
df <- readRDS("Data/rds/E210.seq_astral_95.rds")
df <- df[df$family%in%c('a.25.1.0','a.25.1.2'),]
df <- df[!is.na(df$FF),]
df <- df[,c(8,3,9:218)]
df$length <- as.numeric(df$length)
dis <- as.matrix(proxy::dist(df[,-1], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 10,
            min_dist = 0.1,
            input="dist")
ump_df_seq <- data.frame(data='Astral 95',type='CPE',
                           class=df[,1],
                           UMAP1 = ump$layout[, 1],
                           UMAP2 = ump$layout[, 2])
z <- rbind(ump_df_str,ump_df_seq)
z$data <- 'ASTRAL95'

p2 <- ggplot(z,aes(UMAP1, UMAP2, color= class)) +
    geom_point(alpha=.7) + 
    facet_nested(~ data+type,independent = T,scales = T)+
  ylab('')+xlab('')+
  mytheme()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 18))+
  guides(color = guide_legend(override.aes = list(size = 3)))

C <- ggarrange(NULL,NULL,NULL,NULL,
             NULL,p1,NULL,p2,nrow = 2,ncol = 4,
          common.legend = T,legend = 'right',
          widths = c(.1,1, 0.0, 1),
          heights = c(.07,1),
          labels = c('','','','',
                     '',"C", "", ""),
  font.label = list(size = 30),
  hjust = .2,vjust = 0)
saveRDS(C,'manuscript/Fig4C.rds')
```

##Fig 4 ABC

```{r Fig 4 ABC}
A <- readRDS('manuscript/Fig4A.rds')
B <- readRDS('manuscript/Fig4B.rds')
C <- readRDS('manuscript/Fig4C.rds')
# ------------------------
ggarrange(NULL,A,B,C,ncol = 1,
          heights = c(0.07,1,1,1))
# save FIG4.pdf 10x10
```

## Fig 5 EF

```{r Fig 5 EF}
source('Functions.R')
# ----------------------------------------------------
# ******** a.29.3
# ****** structure40
df <- readRDS("Data/rds/E210.astral_40.rds") 
df = df[!is.na(df$FL),] 
idx<- df$superfamily%in% 'a.29.3'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$family[idx], dis)
fa<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fa)) {  
  print(i)   
  x <- fa[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_family_str <- data.frame(data='ASTRAL40-superfamily a.29.3',type='SPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# ****** sequence40
df <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df = df[!is.na(df$FL),] 
idx<- df$superfamily%in% 'a.29.3'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$family[idx], dis)
fa<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fa)) {  
  print(i)   
  x <- fa[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_family_seq <- data.frame(data='ASTRAL40-superfamily a.29.3',type='CPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# **********
df_family <- rbind(df_family_seq, df_family_str)

E <- ggboxplot(df_family, x='gr',y='distance', 
          fill = 'gr',alpha=.5,outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=8,
               size=2, color="red", fill="red")+xlab('')+
  mytheme()+
  theme(legend.position = 'none',
        axis.text.x = element_blank())+
  scale_fill_viridis(discrete = TRUE, alpha=0.6)+
  stat_compare_means(method = 't.test',size=3,label.y = 18,
                     label.x = 1.4,
                     aes(label = paste0("p = ", ..p.format..)))+
  facet_nested(~ data + type)+
  coord_cartesian(ylim = c(0, 20))

mylegend <- get_legend(E+
                           theme(legend.position = 'bottom',
                                 legend.title = element_blank(),
                                 legend.text = element_text(size = 20)))
saveRDS(mylegend,'manuscript/Fig5mylegend.rds')
# ******************************************
# ****** structure95
df <- readRDS("Data/rds/E210.astral_95.rds") 
df = df[!is.na(df$FL),] 
idx<- df$superfamily%in% 'a.29.3'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$family[idx], dis)
fa<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fa)) {  
  print(i)   
  x <- fa[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_family_str <- data.frame(data='ASTRAL95-superfamily a.29.3',type='SPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# ****** sequence95
df <- readRDS("Data/rds/E210.seq_astral_95.rds") 
df = df[!is.na(df$FL),] 
idx<- df$superfamily%in% 'a.29.3'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$family[idx], dis)
fa<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fa)) {  
  print(i)   
  x <- fa[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_family_seq <- data.frame(data='ASTRAL95-superfamily a.29.3',type='CPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# **********
df_family <- rbind(df_family_seq, df_family_str)

FF <- ggboxplot(df_family, x='gr',y='distance', 
          fill = 'gr',alpha=.5,outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=8,
               size=2, color="red", fill="red")+xlab('')+
  mytheme()+
  theme(legend.position = 'none',
    axis.text.x = element_blank())+
  scale_fill_viridis(discrete = TRUE, alpha=0.6)+
  stat_compare_means(method = 't.test',size=3,
                     label.y = 18,
                     label.x = 1.4,
                     aes(label = paste0("p = ", ..p.format..)))+
  facet_nested(~ data + type)+
  coord_cartesian(ylim = c(0, 20))
# ********
E<-ggarrange(
  NULL,E, ncol = 1,
  heights = c(0.07, 1),
  labels = c('', "E"),
  font.label = list(size = 30), # color = "red"
  hjust = -.5,vjust = 0
)
FF<-ggarrange(
  NULL,FF, ncol = 1,
  heights = c(0.07, 1),
  labels = c('', "F"),
  font.label = list(size = 30), # color = "red"
  hjust = -.5,vjust = 0
)
EF<-ggarrange(
    E, NULL,FF, nrow = 1,
    widths = c(1, 0.3, 1),
    labels = c("", "", "")
    )

saveRDS(EF,'manuscript/Fig5EF.rds')
```

## Fig 5 CD

```{r Fig 5 CD}
source('Functions.R')
# ----------------------------------------------------
# ******** a.29
# ****** structure40
df <- readRDS("Data/rds/E210.astral_40.rds") 
df = df[!is.na(df$FL),] 
idx<- df$fold%in% 'a.29'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$superfamily[idx], dis)
sf<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(sf)) {  
  print(i)   
  x <- sf[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_superfamily_str <- data.frame(data='ASTRAL40-fold a.29',type='SPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# ****** sequence40
df <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df = df[!is.na(df$FL),] 
idx<- df$fold%in% 'a.29'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$superfamily[idx], dis)
sf<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(sf)) {  
  print(i)   
  x <- sf[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_superfamily_seq <- data.frame(data='ASTRAL40-fold a.29',type='CPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# **********
df_superfamily <- rbind(df_superfamily_seq, df_superfamily_str)
my_comparisons<-list(c('within','between'))

C <- ggboxplot(df_superfamily, x='gr',y='distance', 
          fill = 'gr',alpha=.5,outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=8,
               size=2, color="red", fill="red")+xlab('')+
  mytheme()+
  theme(legend.position = 'none',
        axis.text.x = element_blank())+
  scale_fill_viridis(discrete = TRUE, alpha=0.6)+
  stat_compare_means(comparisons = my_comparisons, method = 't.test',
                     size=3,label.y = 17,
                     label.x = 1.4,bracket.size = NA,tip.length = NA)+
  facet_nested(~ data + type)+
  coord_cartesian(ylim = c(0, 20))
# ******************************************
# ****** structure95
df <- readRDS("Data/rds/E210.astral_95.rds") 
df = df[!is.na(df$FL),] 
idx<- df$fold%in% 'a.29'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$superfamily[idx], dis)
sf<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(sf)) {  
  print(i)   
  x <- sf[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_superfamily_str <- data.frame(data='ASTRAL95-fold a.29',type='SPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# ****** sequence95
df <- readRDS("Data/rds/E210.seq_astral_95.rds") 
df = df[!is.na(df$FL),] 
idx<- df$fold%in% 'a.29'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$superfamily[idx], dis)
sf <- unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(sf)) {  
  print(i)   
  x <- sf[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
df_superfamily_seq <- data.frame(data='ASTRAL95-fold a.29',type='CPE',
                            gr=rep(c('within','between'),
                                   c(length(within),length(between))),
                            distance=c(within,between)) 
# **********
df_superfamily <- rbind(df_superfamily_seq, df_superfamily_str)

D <- ggboxplot(df_superfamily, x='gr',y='distance', 
          fill = 'gr',alpha=.5,outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=8,
               size=2, color="red", fill="red")+xlab('')+
  mytheme()+
  theme(legend.position = 'none',
        axis.text.x = element_blank())+
  scale_fill_viridis(discrete = TRUE, alpha=0.6)+
  stat_compare_means(comparisons = my_comparisons, method = 't.test',size=3,
                     label.x = 1.4,label.y = 17,bracket.size = NA,tip.length = NA)+
  facet_nested(~ data + type)+
  coord_cartesian(ylim = c(0, 20))
# ********
C<-ggarrange(
  NULL,C, ncol = 1,
  heights = c(0.07, 1),
  labels = c('', "C"),
  font.label = list(size = 30), # color = "red"
  hjust = -.5,vjust = 0
)
D<-ggarrange(
  NULL,D, ncol = 1,
  heights = c(0.07, 1),
  labels = c('', "D"),
  font.label = list(size = 30), # color = "red"
  hjust = -.5,vjust = 0
)
CD<-ggarrange(
    C, NULL,D, nrow = 1,
    widths = c(1, 0.3, 1),
    labels = c("", "", "")
    )
saveRDS(CD,'manuscript/Fig5CD.rds')
```

## Fig 5 AB

```{r Fig 5 AB}
source('Functions.R')
# ----------------------------------------------------
# ******** a
# ****** structure40
df <- readRDS("Data/rds/E210.astral_40.rds") 
df = df[!is.na(df$FL),] 
idx<- df$class%in% 'a'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$fold[idx], dis)
fo<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fo)) {  
  print(i)   
  x <- fo[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
wit <- within[sample(length(within),1000)] 
bet <- between[sample(length(between),1000)] 
df_fold_str <- data.frame(data='ASTRAL40-class alpha',type='SPE',
                            gr=rep(c('within','between'),c(1000,1000)),
                            distance=c(wit,bet)) 
# ****** sequence40
df <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df = df[!is.na(df$FL),] 
idx<- df$class%in% 'a'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$fold[idx], dis)
fo <- unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fo)) {  
  print(i)   
  x <- fo[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
wit <- within[sample(length(within),1000)] 
bet <- between[sample(length(between),1000)] 
df_fold_seq <- data.frame(data='ASTRAL40-class alpha',type='CPE',
                            gr=rep(c('within','between'),c(1000,1000)),
                            distance=c(wit,bet))
# **********
df_fold <- rbind(df_fold_seq, df_fold_str)
my_comparisons<-list(c('within','between'))

A <- ggboxplot(df_fold, x='gr',y='distance', 
          fill = 'gr',alpha=.5,outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=8,
               size=2, color="red", fill="red")+xlab('')+
  mytheme()+
  theme(legend.position = 'none',
        axis.text.x = element_blank())+
  scale_fill_viridis(discrete = TRUE, alpha=0.6)+
  stat_compare_means(comparisons = my_comparisons, method = 't.test',size=3,
                     label.y = 30,bracket.size = NA,tip.length = NA)+
  facet_nested(~ data + type)+
  coord_cartesian(ylim = c(0, 40))
# ******************************************
# ****** structure95
df <- readRDS("Data/rds/E210.astral_95.rds") 
df = df[!is.na(df$FL),] 
idx<- df$class%in% 'a'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$fold[idx], dis)
fo<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fo)) {  
  print(i)   
  x <- fo[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
wit <- within[sample(length(within),1000)]
bet <- between[sample(length(between),1000)] 
df_fold_str <- data.frame(data='ASTRAL95-class alpha',type='SPE',
                            gr=rep(c('within','between'),c(1000,1000)),
                            distance=c(wit,bet))
# ****** sequence95
df <- readRDS("Data/rds/E210.seq_astral_95.rds") 
df = df[!is.na(df$FL),] 
idx<- df$class%in% 'a'
dis <- as.matrix(dist(df[idx,-c(1:8)],method = manhat))
dis <- data.frame(gr=df$fold[idx], dis)
fo<-unique(dis$gr)

between<-c() 
within<-c()
for (i in 1:length(fo)) {  
  print(i)   
  x <- fo[i]  
  idx <- which(dis$gr==x)
  y <- dis[idx,(idx+1)]
  within <- c(within, y[lower.tri(y)])
  x <- dis[idx,-c(1,idx+1)]   
  x <- as.vector(as.matrix(x))  
  x <- x[!is.na(x)]   
  between<-c(between,x) 
}
wit <- within[sample(length(within),1000)] 
bet <- between[sample(length(between),1000)] 
df_fold_seq <- data.frame(data='ASTRAL95-class alpha',type='CPE',
                            gr=rep(c('within','between'),c(1000,1000)),
                            distance=c(wit,bet)) 
# **********
df_fold <- rbind(df_fold_seq, df_fold_str)

B <- ggboxplot(df_fold, x='gr',y='distance', 
          fill = 'gr',alpha=.5,outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=8,
               size=2, color="red", fill="red")+xlab('')+
  mytheme()+
  theme(legend.position = 'none',
        axis.text.x = element_blank())+
  scale_fill_viridis(discrete = TRUE, alpha=0.6)+
  stat_compare_means(comparisons = my_comparisons, method = 't.test',size=3,
                     label.y = 30, bracket.size = NA,tip.length = NA)+
  facet_nested(~ data + type)+
  coord_cartesian(ylim = c(0, 40))
# ********
A<-ggarrange(
  NULL,A, ncol = 1,
  heights = c(0.07, 1),
  labels = c('', "A"),
  font.label = list(size = 30), # color = "red"
  hjust = -.5,vjust = 0
)
B<-ggarrange(
  NULL,B, ncol = 1,
  heights = c(0.07, 1),
  labels = c('', "B"),
  font.label = list(size = 30), # color = "red"
  hjust = -.5,vjust = 0
)
AB<-ggarrange(
    A, NULL,B, nrow = 1,
    widths = c(1, 0.3, 1),
    labels = c("", "", "")
    )
saveRDS(AB,'manuscript/Fig5AB.rds')
```

##Fig 5 All

```{r Fig 5 All}
EF <- readRDS('manuscript/Fig5EF.rds')
CD <- readRDS('manuscript/Fig5CD.rds')
AB <- readRDS('manuscript/Fig5AB.rds')
mylegend <-readRDS('manuscript/Fig5mylegend.rds')
# ---------------------------------------------
f5all <- ggarrange(NULL,AB,CD,EF,ncol = 1,
          heights = c(0.1,1,1,1))
cowplot::plot_grid(f5all, mylegend, ncol = 1, rel_heights = c(1,.03))
# save pdf 10x9
```

## Fig 6 CT_Ho

```{r Fig 6 CT_Ho}
source('Functions.R')
# ----------------------------------------------------
df <- data.frame(method=c('GR-Align','RMSD','TM-Score',
                          'YH(10Rotation)','YH(2500Rotation)','TM-Vec','CPE'),
                 Accuracy=c(62.3, 59.2, 61.5, 70.8, 81.5, 100, 100),
                 TimeS=c(120, 3600, 33600, 600, 18600, 67, 1))
# ------------------------------------------------------------------------
# ---------   the values for  `GR-Align`, `RMSD`, `TM-Score`, `YH(10Rotation)`, `YH(2500Rotation)` 
# ----------      were previously reported in the `Yau.S et.al. Journal of Biomolecular Structure and Dynamics (2018)`.
# --------------------------------------------------------------------------
df$Time <- round((df$TimeS*100)/(12*3600),5)
df$ratio<-log10(df$Accuracy/df$Time+1)

df <- df[order(df$ratio, decreasing = T),]
df$method <- factor(df$method, 
                    levels = df$method)
mycol <-c('magenta','orange','skyblue3','purple','red','yellow4','green')


p12h <- ggplot(df, aes(x = method, y = Time, fill= method)) +
  geom_bar(stat="identity")+
  coord_polar(theta="y") +
  theme_light(base_rect_size = 0,base_line_size = 1)+
  theme(axis.text = element_blank(),
        axis.ticks=element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank(),
        #legend.position = 'none'
        )+
  scale_fill_manual(values = mycol)+
  ylim(0,100)

p130s <- p12h+xlim(c('CPE','TM-Vec','GR-Align'))+ylim(0,.3)+ #3.0*12*3.6 = 130sec
  theme(legend.text = element_text(face = 'bold',size = 15))

df2 <- df
df2$Time <- df2$TimeS+1
p <- ggplot(df2,aes(Accuracy,Time,col=method,label=method))+
  geom_point(size=7,show.legend = F)+    
  geom_text(show.legend = F,vjust=.7,hjust=1.2,col='black',size=6, fontface='bold')+
  mytheme()+ylab('Time (s)')+
  scale_color_manual(values = mycol)+
  scale_y_log10()+xlim(50,103)+
  theme(axis.text.x = element_text(face = 'bold',color = 'black',size = 20),
        axis.text.y = element_text(face = 'bold',color = 'black',size = 20))
# --------------------------------------------------------------------------
p12h
p130s
p
```


## Fig 7 ferritin

```{r Fig 7 ferritin}
source('Functions.R')
# ----------------------------------------------------
E210_ferritin <- readRDS("Data/rds/E210_ferritin.rds")
df <- E210_ferritin
#sc <- apply(df[,-c(1:3)], 2, FUN = function(x){x/sd(x)})
#df[,-c(1:3)] <- sc
dis <- proxy::dist(df[,-c(1:4)], method = manhat)

nnet <- neighborNet(dis)
ggsplitnet(nnet) + geom_tiplab2(aes(label=label),
                                hjust=-.1,size=5,
                                color='blue')+
  ggexpand(.1) + ggexpand(.1, direction=-1)
# write.nexus.networx(nnet,'Data/rds/E210_ferritin_manhat.nxs')
# --------------------------------------------------------------------
# ----   the 'E210_ferritin_manhat.nxs' file 
# -----      was load on SplitsTree4(v 4.19.2) to visualize
# --------------------------------------------------------------------
```

## Fig 8 covid

```{r Fig 8 covid}
source('Functions.R')
# ----------------------------------------------------
# --------------- CPE -----------------
E210.seq_spike <- readRDS("Data/rds/E210.seq_spike.rds")
df <- E210.seq_spike

rownames(df) <- df$pdbID
x <- df[,-c(1:5)]/df$length
x  <- as.matrix(x) 
dis <- x %>% proxy::dist(method = manhat)
hc <- dis %>% hclust(method = "ward.D2")
adjustedRandIndex(cutree(hc, 3), df$virus)
classError(cutree(hc, 3), df$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus)), ]
row.names(df) <- df$pdbID
rn <- df$pdbID
grp <- list(MERS_Cov     = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2  = rn[64:143])

tree_data <- as.phylo(dend)
p_data <- ggtree(tree_data, layout = 'dendrogram',
                 size = 2)
myBoots <- boot.phylo(tree_data, as.matrix(dis),B = 1000,
                      function(e) bionj(proxy::dist(e,method=manhat)))
p_data$data$boots<-c(rep(NA,143),myBoots)

t_CPE <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(legend.position="none",
        plot.title = element_text(size = 50, face="bold",hjust = 0.5,vjust = 2))+
#  geom_tiplab2(aes(label=label,angle=angle),
#               hjust=-.1,size=1.5,fontface="bold",align=F)+
#  geom_tiplab(aes(label=label),
#               hjust=1,size=1.5,fontface="bold",align=F)+
  scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                      type =  c('black',"blue","green","red" ))+
  ggtitle('CPE')+
  geom_text2(aes(subset=!isTip, label=boots),col='black', hjust=.3)
# -----------------------------------------------------
# ------------ SPE ----------------
E210_spike <- readRDS("Data/rds/E210_spike.rds")
df <- E210_spike

rownames(df) <- df$pdbID
x <- df[,-c(1:5)]/df$length
x  <- as.matrix(x) 
dis <- x %>% proxy::dist(method = manhat)
hc <- dis %>% hclust(method = "ward.D2")
adjustedRandIndex(cutree(hc, 3), df$virus)
classError(cutree(hc, 3), df$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus)), ]
row.names(df) <- df$pdbID
rn <- df$pdbID
grp <- list(MERS_Cov     = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2  = rn[64:143])

tree_data <- as.phylo(dend)
p_data <- ggtree(tree_data, layout = 'dendrogram',
                 #branch.length='none',
                 size = 2) 
myBoots <- boot.phylo(tree_data, as.matrix(dis),B = 1000,
                      function(e) bionj(proxy::dist(e,method=manhat)))
p_data$data$boots<-c(rep(NA,143),myBoots/10)

t_SPE <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(legend.position="none",
        plot.title = element_text(size = 50, face="bold",hjust = 0.5,vjust = 2))+
  scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                      type =  c('black',"blue","green","red"  ))+
  ggtitle('SPE')+
  geom_text2(aes(subset=!isTip, label=boots),col='black', hjust=.3)
# -----------------------------------------------
# ------------- RMSD --------------
df <- E210.seq_spike
rms <- data.frame(readRDS('Data/covidPDB/RMSD_spike.rds'))
diag(rms)<-0

dis <- as.dist(rms)
hc <- dis %>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), df$virus)
classError(cutree(hc, 3), df$virus)


df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

tree_data <- as.phylo(hc)
p_data <- ggtree(tree_data, layout = 'dendrogram',
                 size = 2) 
myBoots <- boot.phylo(tree_data, as.matrix(dis),B = 1000,
                      function(e) bionj(proxy::dist(e,method=manhat)))
p_data$data$boots<-c(rep(NA,143),myBoots/10)

t_RMSS <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 50, face="bold",hjust = 0.5,vjust = 2))+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))+
  ggtitle('RMSD')+
  geom_text2(aes(subset=!isTip, label=boots),col='black', hjust=.3)
# --------------------------------------------
# ----------- TM-Vec -----------------
df <- E210.seq_spike
tm_vec <- read.csv('Data/covidPDB/disTM_vec_spike.csv')
colnames(tm_vec) <- rownames(tm_vec) <- df$pdbID
tm_vec <- 1 - tm_vec

dis <- as.dist(tm_vec)
hc <- dis %>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), df$virus)
classError(cutree(hc, 3), df$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus,decreasing = T)), ]
rn <- df$pdbID
grp <- list(MERS_Cov  = rn[112:143],
            SARS_Cov  = rn[81:111],
            SARS_Cov2 = rn[1:80])

tree_data <- as.phylo(dend)
p_data <- ggtree(tree_data, layout = 'dendrogram',
                 size = 2) 

myBoots <- boot.phylo(tree_data, as.matrix(dis),B = 1000,
                      function(e) bionj(proxy::dist(e,method=manhat)))
p_data$data$boots<-c(rep(NA,143),myBoots/10)
# ggtree(tr) + geom_text(aes(label=node))
p_data <- flip(p_data, 152, 151)

t_tmVec <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 50, face = 'bold',hjust = 0.5,vjust = 2))+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))+
  ggtitle('TM-Vec')+
  geom_text2(aes(subset=!isTip, label=boots),col='black', hjust=.3)
# --------------------------------------
mylegend <- get_legend(t_SPE+
                       theme(legend.position = 'bottom',
                             legend.title = element_blank(),
                             legend.text = element_text(size = 20)))


AB<-ggarrange(NULL,NULL,
    t_CPE,t_SPE, NULL,NULL,
    t_RMSS,t_tmVec,
    ncol = 2,nrow = 5,
    heights = c(.55, 1, .3, 1),
    widths = c(1,1),
    labels = c('',"", "A", "B",'','','C','D'),
    font.label = list(size = 55), # color = "red"
    hjust = 0,vjust = .5
    )
title_grob <- grobTree(
  textGrob("Evolution of Spike protein", x = 0.5, y = -3, just = "center", gp = gpar(col = "black", fontsize = 45, fontface = "bold")),
  textGrob("MERS_Cov",           x = 0.34, y = -9,   just = "center", gp = gpar(col = "blue",  fontsize = 30, fontface = "bold")),
  textGrob(expression('\u2192'), x = 0.42, y = -9.5, just = "center", gp = gpar(col = "black", fontsize = 40, fontface = "bold")),
  textGrob("SARS_Cov",           x = 0.50, y = -9,   just = "center", gp = gpar(col = "green", fontsize = 30, fontface = "bold")),
  textGrob(expression('\u2192'), x = 0.58, y = -9.5, just = "center", gp = gpar(col = "black", fontsize = 40, fontface = "bold")),
  textGrob("SARS_Cov2",          x = 0.67, y = -9,   just = "center", gp = gpar(col = "red"  , fontsize = 30, fontface = "bold"))
)
#cowplot::plot_grid(AB, mylegend, ncol = 1, rel_heights = c(1,.1))
annotate_figure(AB, top = title_grob)
# save FIG6.pdf 20x10
# ----------------------------------------------------------
# ----------------------------------------------------
df <- data.frame(method=c('RMSD','TM-Score','SPE','TM-Vec','CPE'),
                 basedOn=rep(c('Structure based', 'Sequence based'),c(3,2)),
                 CT_3=c(50, 50, 100, 16, 50),
                 CT_4=c(50, 56, 95, 48, 95),
                 TimeS=c(70*60, 9.7*3600, 3*60, 80,0.9))

df$Time <- round((df$TimeS*100)/(12*3600),5)


df <- df[order(df$Time, decreasing = F),]
df$method <- factor(df$method, 
                    levels = df$method)
mycol <-c('magenta','orange','cyan','red','green')


p12h <- ggplot(df, aes(x = method, y = Time, fill= method)) +
  geom_bar(stat="identity")+
  coord_polar(theta="y") +
  theme_light(base_rect_size = 0,base_line_size = 1)+
  theme(axis.text = element_blank(),
        axis.ticks=element_blank(),
        axis.title = element_blank(),
        #legend.position = 'none',
        legend.title = element_blank())+
  scale_fill_manual(values = mycol)+
  ylim(0,100)

p190s <- p12h+xlim(c('CPE','TM-Vec','SPE'))+ylim(0,.44)+ #4.4*12*3.6 = 190sec
    theme(legend.text = element_text(face = 'bold',size = 15))


df2 <- melt(df[,1:4])
df2$variable <- factor(ifelse(df2$variable=='CT_3',3,4))
p <- ggplot(df2, aes(variable,value, fill=method))+
  geom_bar(stat="identity", width = .5,
           position=position_dodge2(preserve = "single"),alpha=1,show.legend = F)+
  facet_grid( ~ basedOn)+xlab('Cut tree')+ylab('ARI')+
  scale_fill_manual(values = mycol)+
  mytheme()+
  theme(strip.text.x = element_text(size = 20, face = 'bold'),
        legend.text = element_text(face = 'bold',size=30),
        axis.text.x = element_text(size = 25, face = 'bold',color = 'black'),
        axis.text.y = element_text(size = 25, face = 'bold',color = 'black'),
        axis.title.x = element_text(size = 25, face = 'bold',color = 'black'),
        axis.title.y = element_text(size = 25, face = 'bold',color = 'black'))
# --------------------------------------------
p12h
p190s
p
```

## Fig 9 Bacteriocin Tm-Vec

```{r Fig 9 Bacteriocin Tm-Vec}
source('Functions.R')
# ----------------------------------------------------
tm <- readRDS('Data/rds/bacteriocin_tm_vec.rds')
tm2 <- tm[!is.na(tm$status2),-24]
colnames(tm2)[24]<-'status'
tm2 <- rbind(tm[,-25],tm2)

tm2 <- tm2[,c(5,20,21,6,23,24)] # 22~6 DeepBlast
colnames(tm2)[-6] <- c('Alphafold2','Omegafold','ESMfold','TM_vec','CPE')
tm2 <- melt(tm2,variable.name = 'method',value.name = 'score')
tm2$method <- factor(tm2$method,levels = c('TM_vec','Alphafold2','Omegafold','ESMfold','CPE'))
p1<-ggplot(tm2, aes(status,score,fill=method))+
  geom_boxplot(outlier.shape = NA,
               color='black',
               size=rep(c(rep(.2,4),1),3),
               alpha=rep(c(rep(.5,4),1),3),
               width=.4
               )+
  coord_cartesian(ylim = c(0.1, 1))+
  xlab('')+
    geom_hline(yintercept = .5, linetype="dashed", 
             color = "red", size=.7)+
  mytheme()+
  theme(legend.title = element_blank(),
        axis.text.y = element_text(size=13),
        axis.text.x = element_text(color = 'black',size = 15, face = 'bold'),
        axis.title.y = element_text(size = 20,vjust = 2, face = 'bold'),
        legend.text = element_text(size = 15))+
  scale_fill_discrete(labels=c('TM_vec','Alphafold2',
                               'Omegafold','ESMfold',
                               expression(bold("CPE"))))

# --------------------------------
# -----  UMAP
df <- readRDS('Data/rds/E210.seq_bacteriocin.rds')
dis <- as.matrix(proxy::dist(df[,-c(1:6)], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 100,
            min_dist = 0.1,
            input="dist")

ump_df <- data.frame(class=df$class,
                     UMAP1 = ump$layout[, 1],
                     UMAP2 = ump$layout[, 2])

p2<-ggplot(ump_df,
       aes(UMAP1, UMAP2, color= class)) +
  geom_point(alpha=.7, size=2) + 
  mytheme()+
  theme(legend.title = element_blank(),
        legend.position = 'bottom',
        axis.title = element_text(size = 15),
        axis.title.y = element_text(size = 15,vjust = 5),
        legend.text = element_text(size = 15))+
  scale_color_manual(values = c('green','magenta','blue'))


p1 <- ggarrange(NULL,NULL,
          NULL,p1,ncol = 2,nrow = 2,
          labels = c('','B'),
          heights = c(0.1,1),
          widths = c(.1,1),
          font.label = list(size = 50),
          hjust = 0,vjust = 1.2)
p2 <- ggarrange(NULL,NULL,
          NULL,p2,ncol = 2,nrow = 2,
          labels = c('','A'),
          heights = c(0.1,1),
          widths = c(.1,1),
          font.label = list(size = 50),
          hjust = .5,vjust = 1.2)

ggarrange(p2,NULL,p1,ncol = 3,nrow = 1,
          widths = c(.5,.05,1))

# save FIG8.pdf 15x8
```

##Fig 10 DrugTarget

```{r Fig 10 DrugTarget}
source('Functions.R')
# ----------------------------------------------------
my_sab <- readRDS('Data/rds/my_sab.rds')
my_sab <- as.data.frame(as.table(my_sab)) 
colnames(my_sab) <- c("d1", "d2", "my_sAB") 
my_sab <- my_sab[!is.na(my_sab$my_sAB), ]
sab<-read_excel('Data/csv/41467_2019_9186_MOESM7_ESM.xlsx')
sab <- sab[-2081,-6]
colnames(sab)[1:2]<-c('d1','d2')

df <- left_join(sab,my_sab,c('d1','d2'))
ggplot(df,aes(sAB,my_sAB))+
  geom_point(alpha=.5)+geom_smooth(method = 'lm')+
  stat_cor(col='red',size=8)+mytheme()+
    theme(axis.title = element_text(size=20),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(size = 13),)+
  xlab('sAB (PPI)')+ylab('sAB (CPE)')
# save FIG9.pdf 10x7
```

## Fig S1

```{r Fig S1}
source('Functions.R')
# ----------------------------------------------------
spike <- read.csv("Data/covidPDB/spike_seq.csv")
df <- spike
# --------------TM score-------------
tm <- read.csv('Data/covidPDB/disTM_score_spike.csv')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
tm_max <- 1 - tm_max
hc <- as.dist(tm_max)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), spike$virus)
classError(cutree(hc, 3), spike$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
tree_data <- as.phylo(dend)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'dendrogram',
                 size = 1) 

groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(#legend.position="none",
    plot.title = element_text(size = 17, hjust = 0.5,vjust = 0))+
  #geom_tiplab2(aes(label=label,angle=angle),
  #              hjust=-.1,size=3.5,fontface="bold",align=F)+
    geom_tiplab(aes(label=label),
               hjust=1,size=1.5,fontface="bold",align=F)+
  scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                       type =  c("blue","green","red" ))+
  ggtitle('TM-Score')
```


#Tables

## Table 2 FiveSF

```{r Table 2 FiveSF}
source('Functions.R')
# -----------------------------------------
# ----------------------CPE------------------------------
# -------- 5 sf
win <- 'a.4.5'
imu <- 'b.1.1'
ph <- 'b.55.1'
ub <- 'd.15.1'
ntf <- 'd.17.4'

fiveSF <- c(win,imu,ph,ub,ntf)
#############
df5 <- readRDS('Data/rds/E210.seq_fiveSF.rds')
# ----------------------------------------
# ---------- 1NN ----------------
# ---------------------------------------
dis <- as.matrix(dist(df5[,-c(1:9)],method = manhat))
diag(dis) <- NA

im <- apply(dis,1, FUN = which.min)
res <- data.frame(source=df5$superfamily, target=df5$superfamily[im])
cm <- matrix(0,5,5)
colnames(cm) <- rownames(cm) <- fiveSF
for (sf in fiveSF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf,names(z)]<-z
}
Accuracy<-sum(diag(cm))/sum(cm)
Precision <- diag(cm)/colSums(cm)
Recall <- diag(cm)/rowSums(cm)
F1 <- (2 * Precision * Recall) /(Precision + Recall)

res1NN_CPE<-data.frame(t(round(c(Accuracy,F1),2)))
# ----------------------------------------
# ---------- 10 fold cross validation Random forest ----------------
# ---------------------------------------
set.seed(12345)
df5$superfamily <- factor(df5$superfamily)
kfolds <- createFolds(df5$superfamily, k = 10)
res<-c()
for (i in 1:10) {
  print(i)
  x <- kfolds[[i]]
  tr <- df5[-x,c(7, 10:219)]
  te <- df5[x,c(7, 10:219)]
  rf = randomForest(superfamily~.,data = tr)
  p2 <- predict(rf, te)
  cm2 <- confusionMatrix(p2, te$superfamily)
  Accuracy <- c(cm2$overall['Accuracy'], F1=cm2$byClass[,'F1'])
  res<-rbind(res,Accuracy)
}
res <- rbind(res,colMeans(res))
res <- round(res,2)
rownames(res) <- c(paste0("Fold_",1:length(kfolds)),'Average')
colnames(res)[-1] <- gsub('.Class','',colnames(res)[-1])
resRF_CPE <- res[11,]
# -----------------
res_final <- rbind(res1NN_CPE, resRF_CPE)
colnames(res_final)<-colnames(res)
# ----------------------------------------------------------------
# ----------------------------------------
# ---------- TM-Vec ----------------
# -------------------------------------------------------
# ----------- load from google drive ---------------
drive_deauth()
drive_user()
public_file <- drive_get(as_id("1coQdrd5zbTT9F0_pBkLARgR-uTHUINiC"))
drive_download(public_file, overwrite = TRUE)
dis<-read.csv('disTM_vec_fiveSF.csv')
file.remove('disTM_vec_fiveSF.csv')
diag(dis) <- NA
# ---------- 1NN ----------------
im <- apply(dis,1, FUN = which.max)
rm(dis)
res <- data.frame(source=df5$superfamily, target=df5$superfamily[im])
cm <- matrix(0,5,5)
colnames(cm) <- rownames(cm) <- fiveSF
for (sf in fiveSF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf,names(z)]<-z
}
Accuracy<-sum(diag(cm))/sum(cm)
Precision <- diag(cm)/colSums(cm)
Recall <- diag(cm)/rowSums(cm)
F1 <- (2 * Precision * Recall) /(Precision + Recall)

res1nn_TM_Vec<-data.frame(t(c(Accuracy,F1)))
colnames(res1nn_TM_Vec) <- colnames(res_final)
# -----------------
res_final <- rbind(res_final, res1nn_TM_Vec)
res_final <- data.frame(method=c('CPE (1NN)','CPE (RF)','TM_Vec (1NN)'),res_final)
res_final
```

## Table 1 CT_Ho

```{r Table 1 CT_Ho}
source('Functions.R')
# ----------------------------------------------------
# ------------------------------------------
# ------------ CPE ---------------------------
# -----------------------------------
df <- readRDS('Data/rds/E210.seq_CT_Ho.rds')
df <- df[!is.na(df$FF),]
twoSF <- unique(df$cathID)
dis <- as.matrix(dist(df[,-c(1:9)], method = manhat))
diag(dis) <- NA

# ---------- 1NN --------------------
im <- apply(dis,1, FUN = which.min)
res <- data.frame(source=df$cathID, target=df$cathID[im])
## ----------
cm <- matrix(0,2,2)
colnames(cm) <- rownames(cm) <- twoSF
for (sf in twoSF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf,names(z)]<-z
}
ac<-round(sum(diag(cm))/sum(cm),2)*100
# ---------------------------------------------
# -------- Note: --------------
# the time was obtaind from the `C-terminal_Homing_CPE` chunck in `Profile_Energy.Rmd` script.
# ---------------------------------------------------------------
res_final <- data.frame(Method='CPE', Accuracy=ac, Time='1 sec') 
# ------------------------------------------
# ------------- TM-vec -----------------------------
# ---------------------------------------------
dis <- read.csv('Data/csv/disTM_vec_CT_Ho.csv')
diag(dis) <- 1
dis <- 1 - dis
diag(dis) <- NA

# ---------- 1NN --------------------
im <- apply(dis,1, FUN = which.min)
res <- data.frame(source=df$cathID, target=df$cathID[im])
## ----------
cm <- matrix(0,2,2)
colnames(cm) <- rownames(cm) <- twoSF
for (sf in twoSF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf,names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100

res_final <- rbind(res_final, c('TM-Vec', ac, '67 sec'))
res_final
```


## Table 3 

```{r Table 3}
source('Functions.R')
# ----------------------------------------------------
# -----------------CPE------------------------
df <- readRDS("Data/rds/E210.seq_spike.rds")
x <- as.matrix(df[,-c(1:5)]/df$length)
hc <- x %>% proxy::dist(method = manhat)
hc <- hc%>% hclust(method = "ward.D2")
ARI_CPE <- c()
for (i in 3:6) {
  ARI_CPE <- c(ARI_CPE, adjustedRandIndex(cutree(hc, i), df$virus))
}
# -----------------------------------
# -----------------SPE------------------------
df <- readRDS("Data/rds/E210_spike.rds")
x <- as.matrix(df[,-c(1:5)]/df$length)
hc <- x %>% proxy::dist(method = manhat)
hc <- hc %>% hclust(method = "ward.D2")
ARI_SPE <- c()
for (i in 3:6) {
  ARI_SPE <- c(ARI_SPE, adjustedRandIndex(cutree(hc, i), df$virus))
}
# -----------------------------------
# -----------------RMSD------------------------
rms <- data.frame(readRDS('Data/covidPDB/RMSD_spike.rds'))
diag(rms)<-0
hc <- as.dist(rms)
hc <- hc %>% hclust(method = "ward.D2")
ARI_RMSD <- c()
for (i in 3:6) {
  ARI_RMSD <- c(ARI_RMSD, adjustedRandIndex(cutree(hc, i), df$virus))
}
# -----------------------------------
# -----------------TM-Vec------------------------
tm_vec <- read.csv('Data/covidPDB/disTM_vec_spike.csv')
colnames(tm_vec) <- rownames(tm_vec) <- df$pdbID
tm_vec <- 1 - tm_vec
hc <- as.dist(tm_vec)
hc <- hc %>% hclust(method = "ward.D2")
ARI_TM_Vec <- c()
for (i in 3:6) {
  ARI_TM_Vec <- c(ARI_TM_Vec, adjustedRandIndex(cutree(hc, i), df$virus))
}
# -----------------------------------
# -----------------TM-score------------------------
tm <- read.csv('Data/covidPDB/disTM_score_spike.csv')
tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
tm_max <- 1 - tm_max
diag(tm_max) <- NA
hc <- as.dist(tm_max)
hc <- hc%>% hclust(method = "ward.D2")
ARI_TM_score <- c()
for (i in 3:6) {
  ARI_TM_score <- c(ARI_TM_score, adjustedRandIndex(cutree(hc, i), df$virus))
}
# --------------------------------
ARI_final <- rbind(ARI_CPE, ARI_SPE, ARI_RMSD, ARI_TM_Vec, ARI_TM_score)
colnames(ARI_final) <- paste0('cut_tree_', 3:6)
ARI_final
```

## Table S1

```{r Table S1}
source('Functions.R')
# ----------------------------------------------------
# -----------------CPE------------------------
df <- readRDS("Data/rds/E210.seq_spike.rds")
x <- as.matrix(df[,-c(1:5)]/df$length)
hc <- x %>% proxy::dist(method = manhat)
hc <- hc%>% hclust(method = "ward.D2")
ARI_CPE <- c()
CE_CPE <- c()
for (i in 3:6) {
  ARI_CPE <- c(ARI_CPE, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_CPE <- c(CE_CPE, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------SPE------------------------
df <- readRDS("Data/rds/E210_spike.rds")
x <- as.matrix(df[,-c(1:5)]/df$length)
hc <- x %>% proxy::dist(method = manhat)
hc <- hc %>% hclust(method = "ward.D2")
ARI_SPE <- c()
CE_SPE <- c()
for (i in 3:6) {
  ARI_SPE <- c(ARI_SPE, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_SPE <- c(CE_SPE, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------RMSD------------------------
rms <- data.frame(readRDS('Data/covidPDB/RMSD_spike.rds'))
diag(rms)<-0
hc <- as.dist(rms)
hc <- hc %>% hclust(method = "ward.D2")
ARI_RMSD <- c()
CE_RMSD <- c()
for (i in 3:6) {
  ARI_RMSD <- c(ARI_RMSD, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_RMSD <- c(CE_RMSD, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------TM-Vec------------------------
tm_vec <- read.csv('Data/covidPDB/disTM_vec_spike.csv')
colnames(tm_vec) <- rownames(tm_vec) <- df$pdbID
tm_vec <- 1 - tm_vec
hc <- as.dist(tm_vec)
hc <- hc %>% hclust(method = "ward.D2")
ARI_TM_Vec <- c()
CE_TM_Vec <- c()
for (i in 3:6) {
  ARI_TM_Vec <- c(ARI_TM_Vec, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_TM_Vec <- c(CE_TM_Vec, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------TM-score------------------------
tm <- read.csv('Data/covidPDB/disTM_score_spike.csv')
tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
tm_max <- 1 - tm_max
diag(tm_max) <- NA
hc <- as.dist(tm_max)
hc <- hc%>% hclust(method = "ward.D2")
ARI_TM_score <- c()
CE_TM_score <- c()
for (i in 3:6) {
  ARI_TM_score <- c(ARI_TM_score, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_TM_score <- c(CE_TM_score, classError(cutree(hc, i), df$virus)$errorRate)
}
# --------------------------------
ARI_final <- rbind(ARI_CPE, ARI_SPE, ARI_RMSD, ARI_TM_Vec, ARI_TM_score,
                   CE_CPE, CE_SPE, CE_RMSD, CE_TM_Vec, CE_TM_score)
colnames(ARI_final) <- paste0('cut_tree_', 3:6)
ARI_final
```

