---
title: "Reviewers Response"
author: "peyman"
date: "2024-08-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load package

```{r}
options(knitr.table.format = "latex")
library(readr)
library(data.table)
library(MASS)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpmisc)
library(ggrepel)
library(ggpubr)
library(ggpointdensity)
library(ggpubr)
library(igraph)
library(fpc)
library(grid)
library(cluster)
library(gridExtra)
library(reshape2)
library(visNetwork)
library(pheatmap)
library(umap)
library(Rtsne)
library(viridis)
library(viridisLite)
library(bio3d)
library(caret)
library(e1071)
library(randomForest)
library(seqinr)
library(geometry)
library(ape)
library(colorspace)
library(dendextend)
library(dynamicTreeCut)
library(caret)
library(ggtree)
library(phangorn)
library(tanggle)
library(stringr)
library(protr)
library(proxy)
library(class)
library(readxl)
library(ggh4x)
library(mclust)
library(googledrive)
```

# Overlap PDBs

```{r}
test4 <- read.csv('Data/csv/fiveSF.csv')
test3 <- read.csv('Data/csv/spike.csv')
test2 <- read.csv('Data/csv/Ferritin_Like_seq.csv')
test1 <- read.csv('Data/csv/CT_Ho_cathID_filtered.csv')
train <- read.csv("Train_Energy/list_with_chainID.txt",header = F)
# -------
pdbs1 <- toupper(substr(test1$pdbID,1,5))
pdbs2 <- toupper(substr(test2$pdbID,1,5))
pdbs3 <- toupper(substr(test3$pdbID,1,5))
pdbs4 <- toupper(paste0(test4$pdbID, substr(test4$position,1,1)))
pdbs <- unique(c(pdbs1, pdbs2, pdbs3, pdbs4))
m <- match(train$V1, pdbs)
idx_rm <- which(!is.na(m))
idx_rm <- data.frame(V1=idx_rm)
write.csv(idx_rm,'Train_Energy/idx_rm.csv',row.names = F)

```

# Pij_old_new

```{r}
Pij <- read.csv("Data/csv/Pij.csv", header = F,sep = ";")
pij_old <- (Pij + t(Pij))/2

Pij_rm_Olaps <- read.csv("Data/csv/Pij_rm_Olaps.csv",
                         header = F,sep = ";")

Pij_new <- (Pij_rm_Olaps + t(Pij_rm_Olaps))/2

df <- data.frame(Pij_old = pij_old[upper.tri(pij_old,diag = T)],
                 Pij_new = Pij_new[upper.tri(Pij_new,diag = T)])

saveRDS(df, 'Data/rds/Pij_old_new.rds')
```

## --- Visual
```{r}
source('Functions.R')
df <- readRDS('Data/rds/Pij_old_new.rds')

p<-ggplot(df, aes(Pij_old, Pij_new))+
  geom_point(size=3, alpha=.5)+
  geom_smooth(method = 'glm',col='skyblue2',linewidth = .2)+
       stat_cor(method = "pearson", size=5,
                r.accuracy = 1e-6,
                color = "red", geom = "label") +
       scale_color_viridis()+
       theme_bw(base_line_size = .3)+
       xlab('Old predictor')+ylab('New predictor')+
  mytheme()

```

# SARS_Proteom Large Scale

```{r}
source('Functions.R')
E210.SPE <- function(pdb){
  tryCatch({
    pdb0 <- pdb
    sele1 <- atom.select(pdb0,"protein",type = "ATOM")
    sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
    sele4 <- atom.select(pdb0, "noh")
    sele <- combine.select(sele1, sele2,sele4, operator="AND", verbose = FALSE)
    new_pdb <- trim.pdb(pdb0, sele,verbose = FALSE)
    pdbx <- new_pdb$atom
    pdbx <- pdbx[!duplicated(pdbx$resno),]
    seq <- paste0(aa321(pdbx$resid),collapse = '')
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    return(c(nchar(seq), seq, energy210))
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
# ------------------------------------------
sars_proteom <- list.dirs("Data/Large_Scale_SARS2",full.names = TRUE)
sars_proteom <- sars_proteom[basename(sars_proteom)!='__pycache__']
sars_proteom <- sars_proteom[basename(sars_proteom)=='RenamedModels']

df <- c()
tictoc::tic()
for (i in 1:length(sars_proteom)) {
  pdbFiles <- list.files(sars_proteom[i],full.names = TRUE)
  pdbs <- purrr::map(pdbFiles, read.pdb)
  print(paste0(i, ': ', length(pdbs)))
  x <- lapply(pdbs, E210.SPE)
  x <- do.call(rbind, x)
  x <- data.frame(sars_proteom=strsplit(sars_proteom[i],'/')[[1]][3],
                  pdbID=basename(pdbFiles),
                  x)
  df <- rbind(df, x)
}
colnames(df)[-c(1,2)] <- c('length', 'seq', pair_inter)
dis_SPE <- as.matrix(proxy::dist(df[,-c(1:4)], method = manhat))
t_SPE <- tictoc::toc()


write.csv(df[,1:4],'Data/Large_Scale_SARS2/sars_proteom.csv',
          row.names = F)
# ---------------
annot <- read.csv('Data/Large_Scale_SARS2/sars_proteom.csv')
annot <- df[,1:4]
df <- data.frame(annot,
                 matrix(NA,ncol=210,nrow=nrow(annot)))
colnames(df)[-c(1:4)] <- pair_inter
tictoc::tic()
for (NP in 1:nrow(df)) {
  print(NP)
  seq <- unlist(strsplit(df$seq[NP],''))
  freq <- c()
  for (j in 1:20){
    freq[j] <-  length(grep(tolower(letters_list[j]),tolower(seq)))
  }
  freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
  en_fr <- aaenergy * freq_matrix
  en_fr <- en_fr/length(seq)
  pair_es <- diag(freq) %*% as.matrix(en_fr)
  aa210_p <- pair_es[lower.tri(pair_es,diag = T)]
  df[NP,5:214] <- aa210_p
}
dis_CPE <- as.matrix(df[,-c(1:4)] %>% proxy::dist(method = manhat))
t_CPE <- tictoc::toc()

save(df_SPE, df_CPE, t_SPE, t_CPE,
     file='Data/Large_Scale_SARS2/SPE_CPE_time.RData')

```

## --- Summary

```{r}
load('Data/Large_Scale_SARS2/SPE_CPE_time.RData')
dis_CPE <- as.matrix(df_CPE[,-c(1:4)] %>% proxy::dist(method = manhat))
dis_SPE <- as.matrix(df_SPE[,-c(1:4)] %>% proxy::dist(method = manhat))
# ----------- load from google drive ---------------
drive_deauth()
drive_user()
public_file <- drive_get(as_id("1QUAqdkypCPHraNESF11arxg29tDUp521"))
drive_download(public_file, overwrite = TRUE)
tm <- read.csv('disTM_vec_sars_proteom.csv')
file.remove('disTM_vec_sars_proteom.csv')
tm <- 1 - tm
# -----------------------
# ----- from run 'Data/Large_Scale_SARS2/tm_vec_sars_proteom.py'
t_tm <- 685 
# ------------------
summary_1NN <- function(dist, group){
  diag(dist) <- NA
  sprot <- unique(group)
  # ---------- 1NN --------------------
  im <- apply(dist,1, FUN = which.min)
  res <- data.frame(source=group, target=group[im])
  ## ----------
  cm <- matrix(0,28,28)
  colnames(cm) <- rownames(cm) <- sprot
  for (sf in sprot) {
    x <- res[res$source%in%sf,]
    z <- table(x$target)
    cm[sf, names(z)]<-z
  }
  ac <- round(sum(diag(cm))/sum(cm), 4)*100
  pr <- round(diag(cm)/colSums(cm) , 4)*100
  re <- round(diag(cm)/rowSums(cm) , 4)*100
  f1 <- round((2*pr*re)/(pr+re))
  summ <- data.frame(t(rbind(ac,pr,re,f1)))
  summ <- rbind(colMeans(summ), summ)
  rownames(summ)[1]<-'Average'
  return(summ)
}

dis <- list(tm, dis_CPE, dis_SPE)
summ <- lapply(dis, summary_1NN, df_CPE$sars_proteom)
names(summ) <- c('TM', 'CPE', 'SPE')


cbind(Method=c('TM', 'CPE', 'SPE'),
      rbind(summ[['TM']][1,],
            summ[['CPE']][1,],
            summ[['SPE']][1,]),
      Time=c(t_tm, t_CPE, t_SPE))
```

## UMAP

```{r}
load('Data/Large_Scale_SARS2/SPE_CPE_time.RData')
library(RColorBrewer)
#---------------------UMAP-------------------------------
dis_SPE <- as.matrix(proxy::dist(df_SPE[,-c(1:4)], method = manhat))
ump <- umap(d = dis_SPE,
            n_neighbors = 150,
            min_dist = 0.1,
            input="dist")
ump <- ump$layout
ump_df <- data.frame(family=df_SPE$sars_proteom, 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])
palette_Dark2 <- colorRampPalette(brewer.pal(28, "Dark2"))
h = ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(size = 3,alpha=.7) +
  mytheme() +
  scale_fill_manual(values = palette_Dark2(14)) +
  theme(legend.position = "bottom")

```

# MSA covid
## --- Visual

```{r}
df <- read.csv("Data/covidPDB/spike_seq.csv")
rownames(df) <- df$pdbID
df <- df[with(df, order(df$virus,decreasing = T)), ]
row.names(df) <- df$pdbID
rn <- df$pdbID
grp <- list(SARS_Cov2  = rn[1:80],
            SARS_Cov  = rn[81:111],
            MERS_Cov  = rn[112:143]
)
# ----------------------------------- 
#    write sequences in FASTA format 
#      to run MSA by Clustal Omega method as online on
#      https://www.ebi.ac.uk/jdispatcher/msa/clustalo
#   default parameters were empolyed.
# ---------
ampir::df_to_faa(df[,c(1,3)],'Data/covidPDB/Spike.fasta')
#  the output save 'Data/covidPDB/Spike.fasta.tree'
# -------------------
msa <- read.tree('Data/covidPDB/Spike.fasta.tree')
tree_data <- as.phylo(msa)
p_data <- ggtree(tree_data, layout = 'dendrogram',
                 size = 1,branch.length = 'none')

t_msa<-groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=20),
        plot.title = element_text(size = 50, face="bold",hjust = 0.5,vjust = 0))+
  scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                       type =  c('black',"blue","green","red" ))+
  ggtitle('MSA')

```

# Ferritin
```{r}
source('Functions.R')
ferritin <- read.csv("Data/csv/Ferritin_Like_seq.csv",sep = ",")
Nprotein <- nrow(ferritin)
E210.seq_ferritin <- data.frame(ferritin,
                            matrix(NA, ncol = 210, 
                                   nrow = Nprotein))
colnames(E210.seq_ferritin)[-c(1:4)] <- pair_inter

for (NP in 1:Nprotein) {
  print(NP)
  seq <- unlist(strsplit(E210.seq_ferritin$seq[NP], ''))
  freq <- c()
    for (j in 1:20){
      freq[j] <-  length(grep(tolower(letters_list[j]),tolower(seq)))
      }
    freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
    en_fr <- aaenergy * freq_matrix
    en_fr <- en_fr/length(seq)
    pair_es <- diag(freq) %*% as.matrix(en_fr)
    aa210_p <- pair_es[lower.tri(pair_es,diag = T)]
    E210.seq_ferritin[NP,5:214] <- aa210_p
}

saveRDS(E210.seq_ferritin,file = "Data/rds/E210.seq_ferritin.rds")
```


## --- Visual NJ

```{r}
E210_ferritin <- readRDS("Data/rds/E210_ferritin.rds")
df <- E210_ferritin
df$group[df$pdbID=='1otkA'] <- 'Pfam_1otkA'
df <- df[with(df, order(df$group)), ]
row.names(df) <- df$pdbID
rn <- df$pdbID
grp <- list(Bacteri     = rn[1:5],
            BMM_alpha = rn[6:7],
            BMM_beta  = rn[8:10],
            Dps  = rn[11:25],
            Fatty_acid  = rn[26:29],
            Ferritins  = rn[30:40],
            Pfam_1otkA = rn[41],
            RNRR2  = rn[42:49],
            Rubrerythrins = rn[50:53])

dis <- proxy::dist(df[,-c(1:3)], method = manhat)

tree_data <- ape::bionj(dis)


p_data <- ggtree(tree_data, layout = 'unrooted',
                 branch.length='none',size = 1.5) 


t_SPE<-groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(legend.position="right",
        legend.title = element_blank(),
        legend.text = element_text(size = 15, colour = "black"))+
  geom_tiplab(aes(label=label),
              hjust=0,size=3.5,fontface="bold",align=F)+
  scale_color_discrete(type =  c('red',"orange2","yellow4","green3",
                                 'skyblue3','blue','black',
                                 'magenta','purple2'
                                 ))
# ----------------------------
E210_ferritin <- readRDS("Data/rds/E210.seq_ferritin.rds")
df <- E210_ferritin
df$group[df$pdbID=='1otkA'] <- 'Pfam_1otkA'
df <- df[with(df, order(df$group)), ]
row.names(df) <- df$pdbID
rn <- df$pdbID
grp <- list(Bacteri     = rn[1:5],
            BMM_alpha = rn[6:7],
            BMM_beta  = rn[8:10],
            Dps  = rn[11:25],
            Fatty_acid  = rn[26:29],
            Ferritins  = rn[30:40],
            Pfam_1otkA = rn[41],
            RNRR2  = rn[42:49],
            Rubrerythrins = rn[50:53])

dis <- proxy::dist(df[,-c(1:4)], method = manhat)

tree_data <- ape::bionj(dis)


p_data <- ggtree(tree_data, layout = 'unrooted',
                 branch.length='none',size = 1.5) 


t_CPE<-groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(legend.position="right",
        legend.title = element_blank(),
        legend.text = element_text(size = 15, colour = "black"))+
  geom_tiplab(aes(label=label),
              hjust=0,size=3.5,fontface="bold",align=F)+
  scale_color_discrete(type =  c('red',"orange2","yellow4","green3",
                                 'skyblue3','blue','black',
                                 'magenta','purple2'
                                 ))
# ----------------------------------------
ferritin <- read.csv('Data/csv/Ferritin_Like_seq.csv')
tm <- read.csv("Data/csv/disTM_vec_Ferritin_Like_seq.csv")
tm <- 1 - tm
colnames(tm) <- rownames(tm) <- ferritin$pdbID

tree_data <- ape::bionj(as.dist(tm))


p_data <- ggtree(tree_data, layout = 'unrooted',
                 branch.length='none',size = 1.5) 


t_tm<-groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(legend.position="right",
        legend.title = element_blank(),
        legend.text = element_text(size = 15, colour = "black"))+
  geom_tiplab(aes(label=label),
              hjust=0,size=3.5,fontface="bold",align=F)+
  scale_color_discrete(type =  c('gray','red',"orange2","yellow4","green3",
                                 'skyblue3','blue','black',
                                 'magenta','purple2'
                                 ))
```

## --- Rho Spearman Rank

```{r}
get_ranks <- function(order, reference_order) {
  ranks <- match(order, reference_order)
  ranks[is.na(ranks)] <- NA 
  return(ranks)
}
# ----------------------------
# ----  a.25.1.1 family
# Define tree orders
reference_order <- c("R", "F", "B", "D")
SPE_order <- c("R", "F", "B", "D")
CPE_order <- c("F", "R", "B", "D")
TM_order <- c("R", "D", "B", "F")

# Compute ranks
reference_ranks <- get_ranks(reference_order, reference_order)
SPE_ranks <- get_ranks(SPE_order, reference_order)
CPE_ranks <- get_ranks(CPE_order, reference_order)
TM_ranks <- get_ranks(TM_order, reference_order)

# Calculate Spearman's rank correlation coefficient
SPE <- cor(reference_ranks, SPE_ranks, 
           method = "spearman", use = "complete.obs")
CPE <- cor(reference_ranks, CPE_ranks, 
           method = "spearman", use = "complete.obs")
TM <- cor(reference_ranks, TM_ranks, 
          method = "spearman", use = "complete.obs")
a.25.1.1 <- c(SPE, CPE, TM)
# -------------------------------
# ----  a.25.1.2 family
# Define tree orders
reference_order <- c("F", "R", "A", "B")
SPE_order <- c("R", "F", "B", "A")
CPE_order <- c("R", "F", "B", "A")
TM_order <- c("B", "R", "F", "A")

reference_ranks <- get_ranks(reference_order, reference_order)
SPE_ranks <- get_ranks(SPE_order, reference_order)
CPE_ranks <- get_ranks(CPE_order, reference_order)
TM_ranks <- get_ranks(TM_order, reference_order)

# Calculate Spearman's rank correlation coefficient
SPE <- cor(reference_ranks, SPE_ranks, 
           method = "spearman", use = "complete.obs")
CPE <- cor(reference_ranks, CPE_ranks, 
           method = "spearman", use = "complete.obs")
TM <- cor(reference_ranks, TM_ranks, 
          method = "spearman", use = "complete.obs")
a.25.1.2 <- c(SPE, CPE, TM)

cbind(Method=c('SPE', 'CPE', 'TM'),
      a.25.1.1, a.25.1.2)
```


# Spike Similarity
This chunk computes the pairwise distance
   between SARS2, SARS, and Mers by three methods.
   - minimum pairwise distance
   - mediod
   - sAB
```{r}
source('Functions.R')
# --------------------SPE-----------
df <- readRDS("Data/rds/E210_spike.rds")
rownames(df) <- df$pdbID
x <- as.matrix(df[,-c(1:4)]/df$length)
dis_SPE <- as.matrix(x %>% proxy::dist(method = manhat))
# ----------------------------------
# -----------------CPE-------------------
df <- readRDS("Data/rds/E210.seq_spike.rds")
rownames(df) <- df$pdbID
x <- as.matrix(df[,-c(1:4)]/df$length)
dis_CPE <- as.matrix(x %>% proxy::dist(method = manhat))
# ------------------------------------------------
# -------------------Seq identity from MSA------------------------
clustalo <- read_table("Data/covidPDB/clustalo.pim",
                       col_names = FALSE, comment = "#")
dis_seqid <- data.frame(clustalo[,-c(1,2)])
colnames(dis_seqid) <- rownames(dis_seqid) <- clustalo$X2
dis_seqid <- dis_seqid/100
dis_seqid <- 1 - dis_seqid
dis_seqid <- dis_seqid[df$pdbID, df$pdbID]
dis_seqid <- as.matrix(dis_seqid)
# -------------------------------------
# -------------RMSD---------------------
rms <- data.frame(readRDS('Data/covidPDB/RMSD_spike.rds'))
colnames(rms)<-rownames(rms)
diag(rms)<-0
rms <- as.matrix(rms)
# -------------------------------------
# -------------TM---------------------
tm <- read.csv('Data/covidPDB/disTM_vec_spike.csv')
colnames(tm) <- rownames(tm) <- df$pdbID
tm <- 1 - tm
tm <- as.matrix(tm)
# -----------------------------
group <- factor(df$virus)
group_indices <- split(seq_len(length(group)), group)
# --------------------------------------------------
# ---------minimum pairwise distance-------------
min_pairwise_dis <- function(dis, gr, gr_idx){
  # Function to calculate minimum pairwise distance between two groups
  calculate_min_distance <- function(group1_indices,
                                     group2_indices,
                                     distance_matrix) {
    submatrix <- distance_matrix[group1_indices, group2_indices]
    return(min(submatrix))
    }
  min_dis <- matrix(NA, nrow = 3, ncol = 3,
                          dimnames = list(levels(gr), 
                                          levels(gr)))
  for (i in 1:3) {
    for (j in 1:3) {
      min_dis[i, j] <- calculate_min_distance(gr_idx[[i]],
                                              gr_idx[[j]],
                                              dis)
    }
  }
  diag(min_dis)<-0
  final_dis <- min_dis
  final_dis <- (final_dis - min(final_dis))/
    (max(final_dis) - min(final_dis))
  final_dis <- round(final_dis,2)
  return(final_dis)
}
# ----------------------------------------------------
# -----------------------Medoid---------------------
medoid_dis <- function(dis, gr, gr_idx){
  # Function to calculate medoid for a group
  calculate_medoid <- function(dist_matrix, group_indices) {
    submatrix <- dist_matrix[group_indices, group_indices]
    medoid_index <- cluster::pam(submatrix, 1)$id.med
    return(grep(rownames(submatrix)[medoid_index],
                rownames(dist_matrix)))
    }
  dis_medoid <- matrix(NA, nrow = 3, ncol = 3,
                       dimnames = list(levels(gr),
                                       levels(gr)))
  for (i in 1:3) {
    for (j in 1:3) {
      x <- calculate_medoid(dis, gr_idx[[i]])
      y <- calculate_medoid(dis, gr_idx[[j]])
      dis_medoid[i, j] <- dis[x,y]
    }
  }
  final_dis <- dis_medoid
  final_dis <- (final_dis - min(final_dis))/
    (max(final_dis) - min(final_dis))
  final_dis <- round(final_dis,2)
  return(final_dis)
}
# -----------------------------------------------
# ----------SAB like drug similarity measure---------------
sAB_dis <- function(dis, gr, gr_idx){
  my_sab <- matrix(0,3,3)
  for (i in 1:3) {
    for (j in 1:3) {
      disi <- dis[gr_idx[[i]], gr_idx[[i]]]
      dii <- mean(diag(as.matrix(disi[apply(disi,2,which.min),])))
      disj <- dis[gr_idx[[j]], gr_idx[[j]]]
      djj <- mean(diag(as.matrix(disj[apply(disj,2,which.min),])))
      disij <- dis[gr_idx[[i]], gr_idx[[j]]]
      disji <- dis[gr_idx[[j]], gr_idx[[i]]]
      dij <- mean(c(diag(as.matrix(disij[apply(disij,2,which.min),])),
                  diag(as.matrix(disji[apply(disji,2,which.min),]))))
      my_sab[i,j] <- dij - ((dii + djj)/2)
    }
  }
  final_dis <- my_sab
  final_dis <- (final_dis - min(final_dis))/
    (max(final_dis) - min(final_dis))
  final_dis <- round(final_dis,2)
  return(final_dis)
}
# -------------------
dists <- list(CPE=dis_CPE,
              SPE=dis_SPE,
              seqid=dis_seqid,
              TM_vec=tm,
              RMSD=rms)

pair_dis_minPair <- lapply(dists, FUN = min_pairwise_dis,
                           gr=group,gr_idx=group_indices)

pair_dis_medoid <- lapply(dists, FUN = medoid_dis,
                          gr=group,gr_idx=group_indices)

pair_dis_sAB <- lapply(dists, FUN = sAB_dis,
                       gr=group,gr_idx=group_indices)


```

# Human RAS superfamily
Nice data :/
```{r}
source('Functions.R')
# ------------ SPE ----------------------
E210.SPE <- function(pdb){
  tryCatch({
    pdb0 <- pdb
    sele1 <- atom.select(pdb0,"protein",type = "ATOM")
    sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
    sele4 <- atom.select(pdb0, "noh")
    sele <- combine.select(sele1, sele2,sele4, operator="AND", verbose = FALSE)
    new_pdb <- trim.pdb(pdb0, sele,verbose = FALSE)
    pdbx <- new_pdb$atom
    pdbx <- pdbx[!duplicated(pdbx$resno),]
    seq <- paste0(aa321(pdbx$resid),collapse = '')
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    return(c(nchar(seq), seq, energy210))
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
# ------------------------------------------
# ------------ ARF ------------
path <- 'Data/HumanRAS/'
fourSubFamily <- as.list(paste0(path,
                                c('ARF', 'RAB', 'RAS', 'RHO'),
                                '-RowData'))
names(fourSubFamily) <- c('ARF', 'RAB', 'RAS', 'RHO')
files <- lapply(fourSubFamily, list.files, full.names=TRUE)

df <- c()
tictoc::tic()
for (i in 1:length(files)) {
  pdbFiles <- files[[i]]
  pdbs <- purrr::map(pdbFiles, read.pdb)
  print(paste0(i, ': ', length(pdbs)))
  x <- lapply(pdbs, E210.SPE)
  x <- do.call(rbind, x)
  x <- data.frame(family=names(files)[i],
                  pdbID=gsub('.pdb','',basename(pdbFiles)),
                  x)
  df <- rbind(df, x)
}
colnames(df)[-c(1:2)] <- c('length','seq',pair_inter)
df <- data.frame(df[,c(1,2,4)], 
                 apply(df[-c(1,2,4)], 2, as.numeric))
rownames(df)<-df$pdbID
dis_SPE <- as.matrix(proxy::dist(df[,-c(1:4)], method = manhat))
tictoc::toc()
write.csv(df[,1:4], 'Data/HumanRAS/annot_HumanRAS.csv',
          row.names = FALSE)

dftot <- data.frame(family=df$family,
                    total=rowSums(df[,-c(1:4)])/df$length)
ggplot(dftot, aes(family, total))+
  geom_boxplot()


ump <- umap(d = dis_SPE,
            n_neighbors = 13,
            min_dist = 0.001,
            input="dist")
ump <- ump$layout
ump <- data.frame(pdbID=rownames(ump), 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

ump_df <- left_join(df[,1:4], ump,'pdbID')

ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(alpha=.7)


diag(dis_SPE) <- NA
fourF <- names(files)
# ---------- 1NN --------------------
im <- apply(dis_SPE,1, FUN = which.min)
res <- data.frame(source=df$family, target=df$family[im])
## ----------
cm <- matrix(0,4,4)
colnames(cm) <- rownames(cm) <- fourF
for (sf in fourF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf, names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100
pr <- round(diag(cm)/colSums(cm) , 2)*100
re <- round(diag(cm)/rowSums(cm) , 2)*100
f1 <- round((2*pr*re)/(pr+re))
rbind(ac,pr,re,f1)
# --------------------------------------
# -----------------CPE---------------
annot <- read.csv('Data/HumanRAS/annot_HumanRAS.csv')

df <- data.frame(annot, matrix(NA, nrow(annot), 210))
colnames(df)[-c(1:4)] <- pair_inter
rownames(df) <- df$pdbID

tictoc::tic()
for (NP in 1:nrow(df)) {
  print(NP)
  seq <- unlist(strsplit(unlist(df$seq[NP]),''))
  freq = c()
  for (j in 1:20){
    freq[j] <-  length(grep(tolower(letters_list[j]),tolower(seq)))
  }
  freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
  en_fr <- aaenergy * freq_matrix
  en_fr <- en_fr/length(seq)
  pair_es <- diag(freq) %*% as.matrix(en_fr)
  aa210_p<-pair_es[lower.tri(pair_es,diag = T)]
  df[NP,-c(1:4)] <- aa210_p
}
dis_CPE <- as.matrix(proxy::dist(df[,-c(1:4)], method = manhat))
tictoc::toc()
dftot <- data.frame(family=df$family,
                    total=rowSums(df[,-c(1:5)])/df$length)
ggplot(dftot, aes(family, total))+
  geom_boxplot()


ump <- umap(d = dis_CPE,
            n_neighbors = 13,
            min_dist = 0.001,
            input="dist")

ump <- ump$layout
ump <- data.frame(pdbID=rownames(ump), 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

ump_df <- left_join(df[,1:4], ump,'pdbID')

ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(alpha=.7)

diag(dis_CPE) <- NA
# ---------- 1NN --------------------
im <- apply(dis_CPE,1, FUN = which.min)
res <- data.frame(source=df$family, target=df$family[im])
## ----------
cm <- matrix(0,4,4)
colnames(cm) <- rownames(cm) <- fourF
for (sf in fourF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf, names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100
pr <- round(diag(cm)/colSums(cm) , 2)*100
re <- round(diag(cm)/rowSums(cm) , 2)*100
f1 <- round((2*pr*re)/(pr+re))
rbind(ac,pr,re,f1)
# --------------------------------
# --------tm-------------
tm <- read.csv('Data/HumanRAS/disTM_vec_HumanRAS.csv')
colnames(tm)<-rownames(tm)<-annot$pdbID
tm <- 1 - tm

ump <- umap(d = tm,
            n_neighbors = 13,
            min_dist = 0.001,
            input="dist")

ump <- ump$layout
ump <- data.frame(pdbID=rownames(ump), 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

ump_df <- left_join(df[,1:4], ump,'pdbID')

ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(alpha=.7)

diag(tm) <- NA
# ---------- 1NN --------------------
im <- apply(tm,1, FUN = which.min)
res <- data.frame(source=df$family, target=df$family[im])
## ----------
cm <- matrix(0,4,4)
colnames(cm) <- rownames(cm) <- fourF
for (sf in fourF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf, names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100
pr <- round(diag(cm)/colSums(cm) , 2)*100
re <- round(diag(cm)/rowSums(cm) , 2)*100
f1 <- round((2*pr*re)/(pr+re))
rbind(ac,pr,re,f1)
```


# scalability

```{r}
source('Functions.R')
E210.seq <- function(seq){
  seq <- unlist(strsplit(unlist(seq),''))
  freq = c()
  for (j in 1:20){
    freq[j] <-  length(grep(tolower(letters_list[j]),tolower(seq)))
  }
  freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
  en_fr <- aaenergy * freq_matrix
  en_fr <- en_fr/length(seq)
  pair_es <- diag(freq) %*% as.matrix(en_fr)
  aa210_p<-pair_es[lower.tri(pair_es,diag = T)]
  return(aa210_p)
}

path <- 'Data/csv/'
astral <- paste0(path,
                 'Astral95_subset_',
                 c(1,seq(5,30,5)),'k.csv')


df <- data.frame(subset=1:7,
                 n_protein=c(1,seq(5,30,5))*1000,
                 sumAA=NA,
                 time=NA)


for (i in 1:nrow(df)) {
  print(i)
  df2 <- read.csv(astral[i])
  tictoc::tic()
  x <- lapply(as.list(df2$seq), E210.seq)
  x <- do.call(rbind, x)
  dis <- x %>% proxy::dist(method = manhat)
  z <- tictoc::toc()
  df$time[i] <- z$toc - z$tic
  df$sumAA[i] <- sum(nchar(df2$seq))
  rm(df2, dis)
}

write.csv(df, 'Data/csv/CPE_prfc_astral95.csv', row.names = F)
```

## --- Visual 
```{r}
source('Functions.R')
cpe <- read.csv('Data/csv/CPE_prfc_astral95.csv')
tm <- read.csv('Data/csv/TM_prfc_astral95.csv')
cpe$method <- 'CPE'
tm$method <- 'TM'

df <- rbind(cpe, tm)

p<-ggplot(df, aes(n_protein, time/sumAA, col=method)) +
  geom_point(size=3, alpha=.5) +
  geom_smooth(method = "lm", se = FALSE, alpha=.3,linewidth = .3) +  
  stat_poly_eq(aes(label = paste(..eq.label..)),
               formula = y ~ x, parse = TRUE, label.x.npc = "right",
               label.y.npc = "top", size = 5)+
  xlab('N Protein')+
  ylab('Time/AminoAcid (Sec/AA)')+
  mytheme()

```

# Globin Alpha_Beta

```{r}
source('Functions.R')
E210.SPE <- function(pdb){
  tryCatch({
    pdb0 <- pdb
    sele1 <- atom.select(pdb0,"protein",type = "ATOM")
    sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
    sele4 <- atom.select(pdb0, "noh")
    sele <- combine.select(sele1, sele2,sele4, operator="AND", verbose = FALSE)
    new_pdb <- trim.pdb(pdb0, sele,verbose = FALSE)
    pdbx <- new_pdb$atom
    pdbx <- pdbx[!duplicated(pdbx$resno),]
    seq <- paste0(aa321(pdbx$resid),collapse = '')
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    return(c(seq,energy210))
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
# -----------------------------------------
globin <- list.dirs("Data/Globin",
                          full.names = TRUE)
globin <- globin[basename(globin)!='Globin']


df <- c()
tictoc::tic()
for (i in 1:length(globin)) {
  pdbFiles <- list.files(globin[i],full.names = TRUE)
  pdbs <- purrr::map(pdbFiles, read.pdb)
  print(paste0(i, ': ', length(pdbs)))
  x <- lapply(pdbs, E210.SPE)
  x <- do.call(rbind, x)
  x <- data.frame(globin=strsplit(globin[i],'/')[[1]][3],
                  pdbID=basename(pdbFiles),
                  x)
  df <- rbind(df, x)
}
colnames(df)[-c(1:2)] <- c('seq',pair_inter)
rownames(df) <- df$pdbID
df <- cbind(df[,1:3],apply(df[,-c(1:3)], 2, FUN = as.numeric))
dis_SPE <- as.matrix(proxy::dist(df[,-c(1:3)], method = manhat))
z <- tictoc::toc()
t_SPE <- z$toc - z$tic
write.csv(df[,1:3],'Data/Globin/Globin.csv',
          row.names = F)
# ---------------
annot <- read.csv('Data/Globin/Globin.csv')
df <- data.frame(annot,
                 matrix(NA,ncol=210,nrow=nrow(annot)))
colnames(df)[-c(1:3)] <- pair_inter
rownames(df) <- df$pdbID
tictoc::tic()
for (NP in 1:nrow(df)) {
  print(NP)
  seq <- unlist(strsplit(df$seq[NP],''))
  freq <- c()
  for (j in 1:20){
    freq[j] <-  length(grep(tolower(letters_list[j]),tolower(seq)))
  }
  freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
  en_fr <- aaenergy * freq_matrix
  en_fr <- en_fr/length(seq)
  pair_es <- diag(freq) %*% as.matrix(en_fr)
  aa210_p <- pair_es[lower.tri(pair_es,diag = T)]
  df[NP, -c(1:3)] <- aa210_p
}
dis_CPE <- as.matrix(df[,-c(1:3)] %>% proxy::dist(method = manhat))
z <- tictoc::toc()
t_CPE <- z$toc - z$tic

save(t_SPE, t_CPE, dis_CPE, dis_SPE,
     file = 'Data/Globin/dis_CPE_SPE_time.RData')
```

## --- Visual
```{r}
load('Data/Globin/dis_CPE_SPE_time.RData')
df <- read.csv('Data/Globin/Globin.csv')
df$globin <- gsub('-.*','',df$globin)
# ---------------------
tm <- read.csv('Data/Globin/disTM_vec_Globin.csv')
colnames(tm)<-rownames(tm)<-df$pdbID
tm <- 1 - tm
diag(tm) <- NA
t_tm <- 4.91
# -------------------------------------
ump <- umap(d = tm,
            n_neighbors = 13,
            min_dist = 0.1,
            input="dist")
ump <- ump$layout
ump <- data.frame(pdbID=rownames(ump), 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

ump_df <- left_join(df, ump,'pdbID')


ggplot(ump_df, aes(UMAP1, UMAP2, color= globin)) +
  geom_point(alpha=.7)


diag(dis_CPE) <- NA
gl <- c('Alpha', 'Beta')
# ---------- 1NN --------------------
im <- apply(dis_CPE,1, FUN = which.min)
res <- data.frame(source=df$globin, target=df$globin[im])
cm <- matrix(0,2,2)
colnames(cm) <- rownames(cm) <- gl
for (sf in gl) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf, names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100
pr <- round(diag(cm)/colSums(cm) , 2)*100
re <- round(diag(cm)/rowSums(cm) , 2)*100
f1 <- round((2*pr*re)/(pr+re))
rbind(ac,pr,re,f1)



```


# PLPRO

```{r}
load('Data/Large_Scale_SARS2/SPE_CPE_time.RData')
df_CPE$pdbID <- gsub('.pdb','',df_CPE$pdbID)
df_SPE$pdbID <- gsub('.pdb','',df_SPE$pdbID)
# ----------- load TM from google drive ---------------
drive_deauth()
drive_user()
public_file <- drive_get(as_id("1QUAqdkypCPHraNESF11arxg29tDUp521"))
drive_download(public_file, overwrite = TRUE)
tm <- read.csv('disTM_vec_sars_proteom.csv')
file.remove('disTM_vec_sars_proteom.csv')
tm <- 1 - tm
# ------------------------------------
# -------------------
idx_PLpro <- grep('PLPro', df_CPE$sars_proteom)

df_CPE <- df_CPE[idx_PLpro,]
df_SPE <- df_SPE[idx_PLpro,]
rownames(df_CPE) <- df_CPE$pdbID
rownames(df_SPE) <- df_SPE$pdbID

tm <- tm[idx_PLpro, idx_PLpro]
colnames(tm) <- rownames(tm) <- df_CPE$pdbID

c1 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster1.txt', header = F)


c2 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster2.txt', header = F)

c3 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster3.txt', header = F)

c4 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster4.txt', header = F)



df_CPE <- data.frame(subClass=NA, df_CPE)
df_CPE$subClass[df_CPE$pdbID%in%c1$V1] <- 'Sarb'
df_CPE$subClass[df_CPE$pdbID%in%c2$V1] <- 'Nob'
df_CPE$subClass[df_CPE$pdbID%in%c3$V1] <- 'Merb'
df_CPE$subClass[df_CPE$pdbID%in%c4$V1] <- 'Emb'

df_SPE <- data.frame(subClass=NA, df_SPE)
df_SPE$subClass[df_SPE$pdbID%in%c1$V1] <- 'Sarb'
df_SPE$subClass[df_SPE$pdbID%in%c2$V1] <- 'Nob'
df_SPE$subClass[df_SPE$pdbID%in%c3$V1] <- 'Merb'
df_SPE$subClass[df_SPE$pdbID%in%c4$V1] <- 'Emb'


dis_CPE <- as.matrix(proxy::dist(df_CPE[,-c(1:5)],
                                 method = manhat))
dis_SPE <- as.matrix(proxy::dist(df_SPE[,-c(1:5)],
                                 method = manhat))

ump <- umap(d = tm,
            n_neighbors = 13,
            input='dist',
            min_dist = 0.9
            )

ump <- ump$layout
ump <- data.frame(pdbID=rownames(ump), 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])


ump_df <- left_join(df_CPE[,1:5], ump, 'pdbID')

ggplot(ump_df, aes(UMAP1, UMAP2, color= subClass)) +
  geom_point(alpha=.7,size=3)


```


# regenerat Fig 6
add SPE 
```{r}
source('Functions.R')
# ----------------------------------------------------
df <- read.csv('Data/csv/CT_Ho_cathID_filtered.csv')

E210_CT_Ho <- data.frame(df,
                         matrix(NA, ncol = 210, nrow = nrow(df)))

colnames(E210_CT_Ho)[-c(1:9)] <- pair_inter

E210_CT_Ho <- data.frame(spike,
                            matrix(NA,ncol=210,nrow=Nprotein))

colnames(E210_CT_Ho)[-c(1:4)] <- pair_inter

tictoc::tic()
for (NP in 1:nrow(E210.seq_astral_95)) {
  if (NP %% 50 == 0) {print(NP)}
  chain_resno <- split_position(astral$Position[NP])
  pdbname <- astral$pdbID[NP]
  tryCatch({
    pdb0 <- read.pdb(pdbname,verbose = FALSE)
    pdblist = list()
    for (ind in 1:dim(chain_resno)[1]){
      sele1 <- atom.select(pdb0,"protein",type = "ATOM", chain=chain_resno$chain[ind])
      sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
      sele4 <- atom.select(pdb0, "noh")
      sele <- combine.select(sele1, sele2,sele4, operator="AND")
      if (!(chain_resno$start[ind]=="NA") & !(chain_resno$end[ind])=="NA"){
         st <- chain_resno$start[ind]
         en <- chain_resno$end[ind]
         sele3 <- atom.select(pdb0,  resno=st:en, verbose=FALSE)
         sele <- combine.select(sele1, sele2,sele3,sele4, operator="AND")
      }
      pdblist[[ind]] <- trim.pdb(pdb0, sele,verbose = FALSE)
    }
    new_pdb = pdblist[[1]]
    if (dim(chain_resno)[1] > 1) {
      for (ind in 2:dim(chain_resno)[1]){
      new_pdb <- cat.pdb(new_pdb, pdblist[[ind]], rechain=FALSE)
      }
    }
    pdbX <- new_pdb$atom
    E210.astral_95$length[NP] = length(unique(pdbX$resno))
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    E210.astral_95[NP,-c(1:8)] <- energy210
    }, error = function(e) {
     cat("Error downloading file:", e$message, "\n")
    })
}
dis <- E210_spike[,-c(1:4)] %>% proxy::dist(method = manhat)
tictoc::toc()

```

edit  ferritin net in PP
add SPE for fiveSF and CT_Ho

CPU
11th Gen Intel(R) Core(TM) i9-11950H @ 2.60GHz
Thread(s) per core:   2
Core(s) per socket:   8
Memory:        32GB
