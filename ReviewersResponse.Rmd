---
title: "Reviewers Response"
author: "peyman"
date: "2024-08-16"
output: html_document
---

CPU
11th Gen Intel(R) Core(TM) i9-11950H @ 2.60GHz
Thread(s) per core:   2
Core(s) per socket:   8
Memory:        32GB


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load package

```{r Load package}
options(knitr.table.format = "latex")
library(RColorBrewer)
library(scales)
library(readr)
library(data.table)
library(MASS)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpmisc)
library(ggrepel)
library(ggpubr)
library(ggpointdensity)
library(ggpubr)
library(igraph)
library(fpc)
library(grid)
library(cluster)
library(gridExtra)
library(reshape2)
library(visNetwork)
library(pheatmap)
library(umap)
library(Rtsne)
library(viridis)
library(viridisLite)
library(bio3d)
library(caret)
library(e1071)
library(randomForest)
library(seqinr)
library(geometry)
library(ape)
library(colorspace)
library(dendextend)
library(dynamicTreeCut)
library(caret)
library(ggtree)
library(phangorn)
library(tanggle)
library(stringr)
library(protr)
library(proxy)
library(class)
library(readxl)
library(ggh4x)
library(mclust)
library(googledrive)
library(Biostrings)
library(msa)
library(lsa)
library(TreeDist)
library(binom)
```

# Overlap PDBs

```{r Overlap PDBs}
test4 <- read.csv('Data/csv/fiveSF.csv')
test3 <- read.csv('Data/csv/spike.csv')
test2 <- read.csv('Data/csv/Ferritin_Like_seq.csv')
test1 <- read.csv('Data/csv/CT_Ho_cathID_filtered.csv')
train <- read.csv("Train_Energy/list_with_chainID.txt",header = F)
# -------
pdbs1 <- toupper(substr(test1$pdbID,1,5))
pdbs2 <- toupper(substr(test2$pdbID,1,5))
pdbs3 <- toupper(substr(test3$pdbID,1,5))
pdbs4 <- toupper(paste0(test4$pdbID, substr(test4$position,1,1)))
pdbs <- unique(c(pdbs1, pdbs2, pdbs3, pdbs4))
m <- match(train$V1, pdbs)
idx_rm <- which(!is.na(m))
idx_rm <- data.frame(V1=idx_rm)
write.csv(idx_rm,'Train_Energy/idx_rm.csv',row.names = F)

```

# Pij_old_new

```{r Pij_old_new}
Pij <- read.csv("Data/csv/Pij.csv", header = F,sep = ";")
pij_old <- (Pij + t(Pij))/2

Pij_rm_Olaps <- read.csv("Data/csv/Pij_rm_Olaps.csv",
                         header = F,sep = ";")

Pij_new <- (Pij_rm_Olaps + t(Pij_rm_Olaps))/2

df <- data.frame(Pij_old = pij_old[upper.tri(pij_old,diag = T)],
                 Pij_new = Pij_new[upper.tri(Pij_new,diag = T)])

saveRDS(df, 'Data/rds/Pij_old_new.rds')
```

## --- PijVisual
```{r PijVisual}
source('Functions.R')
df <- readRDS('Data/rds/Pij_old_new.rds')

p<-ggplot(df, aes(Pij_old, Pij_new))+
  geom_point(size=3, alpha=.5)+
  geom_smooth(method = 'glm',col='skyblue2',linewidth = .2)+
       stat_cor(method = "pearson", size=5,
                r.accuracy = 1e-6,
                color = "red", geom = "label") +
       scale_color_viridis()+
       theme_bw(base_line_size = .3)+
       xlab('Old predictor')+ylab('New predictor')+
  mytheme()

```

# SARS_Proteom Large Scale

```{r SARS_Proteom Large Scale}
source('Functions.R')
E210.SPE <- function(pdb){
  tryCatch({
    pdb0 <- pdb
    sele1 <- atom.select(pdb0,"protein",type = "ATOM")
    sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
    sele4 <- atom.select(pdb0, "noh")
    sele <- combine.select(sele1, sele2,sele4, operator="AND", verbose = FALSE)
    new_pdb <- trim.pdb(pdb0, sele,verbose = FALSE)
    pdbx <- new_pdb$atom
    pdbx <- pdbx[!duplicated(pdbx$resno),]
    seq <- paste0(aa321(pdbx$resid),collapse = '')
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    return(c(nchar(seq), seq, energy210))
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
# ------------------------------------------
sars_proteom <- list.dirs("Data/Large_Scale_SARS2",full.names = TRUE)
sars_proteom <- sars_proteom[basename(sars_proteom)!='__pycache__']
sars_proteom <- sars_proteom[basename(sars_proteom)=='RenamedModels']

df <- c()
tictoc::tic()
for (i in 1:length(sars_proteom)) {
  pdbFiles <- list.files(sars_proteom[i],full.names = TRUE)
  pdbs <- purrr::map(pdbFiles, read.pdb)
  print(paste0(i, ': ', length(pdbs)))
  x <- lapply(pdbs, E210.SPE)
  x <- do.call(rbind, x)
  x <- data.frame(sars_proteom=strsplit(sars_proteom[i],'/')[[1]][3],
                  pdbID=basename(pdbFiles),
                  x)
  df <- rbind(df, x)
}
colnames(df)[-c(1,2)] <- c('length', 'seq', pair_inter)
dis_SPE <- as.matrix(proxy::dist(df[,-c(1:4)], method = manhat))
t_SPE <- tictoc::toc()


write.csv(df[,1:4],'Data/Large_Scale_SARS2/sars_proteom.csv',
          row.names = F)
# ---------------
annot <- read.csv('Data/Large_Scale_SARS2/sars_proteom.csv')
annot <- df[,1:4]
df <- data.frame(annot,
                 matrix(NA,ncol=210,nrow=nrow(annot)))
colnames(df)[-c(1:4)] <- pair_inter
tictoc::tic()
for (NP in 1:nrow(df)) {
  print(NP)
  seq <- df$seq[NP]
  aa210_p <- Energy_CPE210(seq)
  df[NP,5:214] <- aa210_p
}
dis_CPE <- as.matrix(df[,-c(1:4)] %>% proxy::dist(method = manhat))
t_CPE <- tictoc::toc()

save(df_SPE, df_CPE, t_SPE, t_CPE,
     file='Data/Large_Scale_SARS2/SPE_CPE_time.RData')

```

## --- Table 5 and Table S3-S5 performance

```{r Table 5 performance}
source('Functions.R')
load('Data/Large_Scale_SARS2/SPE_CPE_time.RData')
dff <- df_CPE[,-c(1:4)]/as.numeric(df_CPE$length)
dis_CPE <- as.matrix(dff %>% proxy::dist(method = manhat))
dff = df_SPE[,-c(1:4)]/as.numeric(df_SPE$length)
dis_SPE <- as.matrix(dff %>% proxy::dist(method = manhat))
# ----------- load from google drive ---------------
drive_deauth()
drive_user()
public_file <- drive_get(as_id("1QUAqdkypCPHraNESF11arxg29tDUp521"))
drive_download(public_file, overwrite = TRUE)
tm <- read.csv('disTM_vec_sars_proteom.csv')
file.remove('disTM_vec_sars_proteom.csv')
tm <- 1 - tm
# -----------------------
# ----- from run 'Data/Large_Scale_SARS2/tm_vec_sars_proteom.py'
t_tm <- 685 
# ------------------
summary_1NN <- function(dist, group){
  diag(dist) <- NA
  sprot <- unique(group)
  # ---------- 1NN --------------------
  im <- apply(dist,1, FUN = which.min)
  res <- data.frame(source=group, target=group[im])
  ## ----------
  cm <- matrix(0,28,28)
  colnames(cm) <- rownames(cm) <- sprot
  for (sf in sprot) {
    x <- res[res$source%in%sf,]
    z <- table(x$target)
    cm[sf, names(z)]<-z
  }
  ac <- round(sum(diag(cm))/sum(cm), 4)*100
  pr <- round(diag(cm)/colSums(cm) , 4)*100
  re <- round(diag(cm)/rowSums(cm) , 4)*100
  f1 <- round((2*pr*re)/(pr+re))
  summ <- data.frame(t(rbind(ac,pr,re,f1)))
  summ <- rbind(colMeans(summ), summ)
  rownames(summ)[1]<-'Average'
  return(summ)
}

dis <- list(tm, dis_CPE, dis_SPE)

summ <- lapply(dis, summary_1NN, df_CPE$sars_proteom)
names(summ) <- c('TM', 'CPE', 'SPE')


cbind(Method=c('TM', 'CPE', 'SPE'),
      rbind(summ[['TM']][1,],
            summ[['CPE']][1,],
            summ[['SPE']][1,]),
      Time=c(t_tm, t_CPE, t_SPE))
```

## --- Fig S6-S8 UMAP

```{r Fig S6-S8 UMAP}
source('Functions.R')
load('Data/Large_Scale_SARS2/SPE_CPE_time.RData')
palette_Dark2 <- colorRampPalette(brewer.pal(28, "Dark2"))
#---------------------------------------------
# ----------SPE
dis <- as.matrix(proxy::dist(df_SPE[,-c(1:4)], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 150,
            min_dist = 0.1,
            input="dist")
ump <- ump$layout
ump_df <- data.frame(family=df_SPE$sars_proteom, 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

p_SPE <- ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(size = 3,alpha=.7) +
  scale_fill_manual(values = palette_Dark2(14)) +
  mytheme()+
  ggtitle('SPE')+
  theme(legend.position = "bottom",
        legend.text = element_text(size=13,color = 'black'),
        axis.text.x = element_text(size = 25,face = 'bold',color = 'black'),
        axis.text.y = element_text(size = 25,face = 'bold',color = 'black'),
        axis.title.x = element_text(size =25,face = 'bold',color = 'black'),
        axis.title.y = element_text(size =25,face = 'bold',color = 'black'),
        title = element_text(size =25,face = 'bold',color = 'black'))
# save SARS_Proteom_SPE.pdf 13x17
# ------------------------------------
# ------------CPE
dis <- as.matrix(proxy::dist(df_CPE[,-c(1:4)], method = manhat))
ump <- umap(d = dis,
            n_neighbors = 150,
            min_dist = 0.1,
            input="dist")
ump <- ump$layout
ump_df <- data.frame(family=df_CPE$sars_proteom, 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

p_CPE <- ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(size = 3,alpha=.7) +
  scale_fill_manual(values = palette_Dark2(14)) +
  mytheme()+
  ggtitle('CPE')+
  theme(legend.position = "bottom",
        legend.text = element_text(size=13,color = 'black'),
        axis.text.x = element_text(size = 25,face = 'bold',color = 'black'),
        axis.text.y = element_text(size = 25,face = 'bold',color = 'black'),
        axis.title.x = element_text(size =25,face = 'bold',color = 'black'),
        axis.title.y = element_text(size =25,face = 'bold',color = 'black'),
        title = element_text(size =25,face = 'bold',color = 'black'))
# save SARS_Proteom_CPE.pdf 13x17
# ------------------------------------
# ------------TM-vec
# ----------- load from google drive ---------------
drive_deauth()
drive_user()
public_file <- drive_get(as_id("1QUAqdkypCPHraNESF11arxg29tDUp521"))
drive_download(public_file, overwrite = TRUE)
tm <- read.csv('disTM_vec_sars_proteom.csv')
file.remove('disTM_vec_sars_proteom.csv')
tm <- 1 - tm
ump <- umap(d = tm,
            n_neighbors = 150,
            min_dist = 0.1,
            input="dist")
ump <- ump$layout
ump_df <- data.frame(family=df_CPE$sars_proteom, 
                  UMAP1=ump[,1],
                  UMAP2=ump[,2])

p_tm <- ggplot(ump_df, aes(UMAP1, UMAP2, color= family)) +
  geom_point(size = 3,alpha=.7) +
  scale_fill_manual(values = palette_Dark2(14)) +
  mytheme()+
  ggtitle('TM-Vec')+
  theme(legend.position = "bottom",
        legend.text = element_text(size=13,color = 'black'),
        axis.text.x = element_text(size = 25,face = 'bold',color = 'black'),
        axis.text.y = element_text(size = 25,face = 'bold',color = 'black'),
        axis.title.x = element_text(size =25,face = 'bold',color = 'black'),
        axis.title.y = element_text(size =25,face = 'bold',color = 'black'),
        title = element_text(size =25,face = 'bold',color = 'black'))
# save SARS_Proteom_TM_Vec.pdf 13x17
# -------------------------
#ggarrange(p_SPE,p_CPE,p_tm,common.legend = T,ncol = 1, legend = 'bottom')
```

## --- Fig 13 (PLPRO)

```{r Fig 13 (PLPRO)}
source('Functions.R')
load('Data/Large_Scale_SARS2/SPE_CPE_time.RData')
df_CPE$pdbID <- gsub('.pdb','',df_CPE$pdbID)
df_SPE$pdbID <- gsub('.pdb','',df_SPE$pdbID)
# ----------- load TM from google drive ---------------
drive_deauth()
drive_user()
public_file <- drive_get(as_id("1QUAqdkypCPHraNESF11arxg29tDUp521"))
drive_download(public_file, overwrite = TRUE)
tm <- read.csv('disTM_vec_sars_proteom.csv')
file.remove('disTM_vec_sars_proteom.csv')
tm <- 1 - tm
# ------------------------------------
# -------------------
idx_PLpro <- grep('PLPro', df_CPE$sars_proteom)

df_CPE <- df_CPE[idx_PLpro,]
df_SPE <- df_SPE[idx_PLpro,]
rownames(df_CPE) <- df_CPE$pdbID
rownames(df_SPE) <- df_SPE$pdbID

tm <- tm[idx_PLpro, idx_PLpro]
colnames(tm) <- rownames(tm) <- df_CPE$pdbID

c1 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster1.txt', header = F)


c2 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster2.txt', header = F)

c3 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster3.txt', header = F)

c4 <- read.delim('Data/Large_Scale_SARS2/NSP3_cd21732_betaCoV_PLPro/cluster4.txt', header = F)


df_CPE <- data.frame(subClass=NA, df_CPE)
df_CPE$subClass[df_CPE$pdbID%in%c1$V1] <- 'Sarb'
df_CPE$subClass[df_CPE$pdbID%in%c2$V1] <- 'Nob'
df_CPE$subClass[df_CPE$pdbID%in%c3$V1] <- 'Merb'
df_CPE$subClass[df_CPE$pdbID%in%c4$V1] <- 'Emb'

df_SPE <- data.frame(subClass=NA, df_SPE)
df_SPE$subClass[df_SPE$pdbID%in%c1$V1] <- 'Sarb'
df_SPE$subClass[df_SPE$pdbID%in%c2$V1] <- 'Nob'
df_SPE$subClass[df_SPE$pdbID%in%c3$V1] <- 'Merb'
df_SPE$subClass[df_SPE$pdbID%in%c4$V1] <- 'Emb'

dff <- df_CPE[,-c(1:5)]/as.numeric(df_CPE$length)
dis_CPE <- as.matrix(proxy::dist(dff,
                                 method = manhat))
dff <- df_SPE[,-c(1:5)]/as.numeric(df_SPE$length)
dis_SPE <- as.matrix(proxy::dist(dff,
                                 method = manhat))

ump_tm <- umap(d = tm,n_neighbors = 13,input='dist',min_dist = 0.5)
ump_tm <- ump_tm$layout
ump_tm <- data.frame(pdbID=rownames(ump_tm), 
                  UMAP1=ump_tm[,1],
                  UMAP2=ump_tm[,2])
ump_tm <- left_join(df_CPE[,1:5], ump_tm, 'pdbID')
#----------------------CPE-----------
ump_CPE <- umap(d = dis_CPE,n_neighbors = 13,input='dist',min_dist = 0.5)
ump_CPE <- ump_CPE$layout
ump_CPE <- data.frame(pdbID=rownames(ump_CPE), 
                  UMAP1=ump_CPE[,1],
                  UMAP2=ump_CPE[,2])
ump_CPE <- left_join(df_CPE[,1:5], ump_CPE, 'pdbID')
#----------------SPE--------------------
ump_SPE <- umap(d = dis_SPE,n_neighbors = 13,input='dist',min_dist = 0.5)
ump_SPE <- ump_SPE$layout
ump_SPE <- data.frame(pdbID=rownames(ump_SPE), 
                  UMAP1=ump_SPE[,1],
                  UMAP2=ump_SPE[,2])
ump_SPE <- left_join(df_CPE[,1:5], ump_SPE, 'pdbID')
# ----------------
ump_df <- data.frame(Method = rep(c('SPE', 'CPE', 'TM-Vec'), each=nrow(ump_CPE)),
                     rbind(ump_SPE, ump_CPE, ump_tm))

ump_df$Method <- factor(ump_df$Method,
                        levels = c('SPE', 'CPE', 'TM-Vec'))

p<-ggplot(ump_df, aes(UMAP1, UMAP2, color= subClass)) +
  geom_point(alpha=.7,size=3) +
  facet_grid( ~ Method)+
  mytheme() +
  theme(strip.text.x = element_text(size = 13, face = 'bold'))
# save Fig13_new.pdf 10x5
```

# Globin AlphaBeta SPE_CPE

```{r Globin AlphaBeta SPE_CPE}
source('Functions.R')
E210.SPE <- function(pdb){
  tryCatch({
    pdb0 <- pdb
    sele1 <- atom.select(pdb0,"protein",type = "ATOM")
    sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
    sele4 <- atom.select(pdb0, "noh")
    sele <- combine.select(sele1, sele2,sele4, operator="AND", verbose = FALSE)
    new_pdb <- trim.pdb(pdb0, sele,verbose = FALSE)
    pdbx <- new_pdb$atom
    pdbx <- pdbx[!duplicated(pdbx$resno),]
    seq <- paste0(aa321(pdbx$resid),collapse = '')
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    return(c(seq,energy210))
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
# -----------------------------------------
globin <- list.dirs("Data/Globin",
                          full.names = TRUE)
globin <- globin[basename(globin)!='Globin']


df <- c()
tictoc::tic()
for (i in 1:length(globin)) {
  pdbFiles <- list.files(globin[i],full.names = TRUE)
  pdbs <- purrr::map(pdbFiles, read.pdb)
  print(paste0(i, ': ', length(pdbs)))
  x <- lapply(pdbs, E210.SPE)
  x <- do.call(rbind, x)
  x <- data.frame(globin=strsplit(globin[i],'/')[[1]][3],
                  pdbID=basename(pdbFiles),
                  x)
  df <- rbind(df, x)
}
colnames(df)[-c(1:2)] <- c('seq',pair_inter)
rownames(df) <- df$pdbID
df <- cbind(df[,1:3],apply(df[,-c(1:3)], 2, FUN = as.numeric))
dis_SPE <- as.matrix(proxy::dist(df[,-c(1:3)], method = manhat))
z <- tictoc::toc()
t_SPE <- z$toc - z$tic
write.csv(df[,1:3],'Data/Globin/Globin.csv',
          row.names = F)
# ---------------
annot <- read.csv('Data/Globin/Globin.csv')
df <- data.frame(annot,
                 matrix(NA,ncol=210,nrow=nrow(annot)))
colnames(df)[-c(1:3)] <- pair_inter
rownames(df) <- df$pdbID
tictoc::tic()
for (NP in 1:nrow(df)) {
  print(NP)
  seq <- df$seq[NP]
  aa210_p <- Energy_CPE210(seq)
  df[NP, -c(1:3)] <- aa210_p
}
dis_CPE <- as.matrix(df[,-c(1:3)] %>% proxy::dist(method = manhat))
z <- tictoc::toc()
t_CPE <- z$toc - z$tic

save(t_SPE, t_CPE, dis_CPE, dis_SPE,
     file = 'Data/Globin/dis_CPE_SPE_time.RData')
```

## --- Fig 8
```{r Fig 8}
source('Functions.R')
# ------------------------
load('Data/Globin/dis_CPE_SPE_time.RData')
df <- read.csv('Data/Globin/Globin.csv')
df$globin <- gsub('-.*','',df$globin)
# ---------------------
tm <- read.csv('Data/Globin/disTM_vec_Globin.csv')
colnames(tm)<-rownames(tm)<-df$pdbID
tm <- 1 - tm
diag(tm) <- NA
t_tm <- 4.91
# ------------------tm----------------
ump_tm <- umap(d = tm,
            n_neighbors = 13,
            min_dist = 0.1,
            input="dist")
ump_tm <- ump_tm$layout
ump_tm <- data.frame(pdbID=rownames(ump_tm), 
                  UMAP1=ump_tm[,1],
                  UMAP2=ump_tm[,2])
ump_tm <- left_join(df, ump_tm,'pdbID')
# ------------------cpe----------------
ump_cpe <- umap(d = dis_CPE,
            n_neighbors = 13,
            min_dist = 0.1,
            input="dist")
ump_cpe <- ump_cpe$layout
ump_cpe <- data.frame(pdbID=rownames(ump_cpe), 
                  UMAP1=ump_cpe[,1],
                  UMAP2=ump_cpe[,2])
ump_cpe <- left_join(df, ump_cpe,'pdbID')
# ------------------SPE----------------
ump_spe <- umap(d = dis_SPE,
            n_neighbors = 13,
            min_dist = 0.1,
            input="dist")
ump_spe <- ump_spe$layout
ump_spe <- data.frame(pdbID=rownames(ump_spe), 
                  UMAP1=ump_spe[,1],
                  UMAP2=ump_spe[,2])
ump_spe <- left_join(df, ump_spe,'pdbID')
# ---------------------
ump_df <- data.frame(Method = rep(c('SPE', 'CPE', 'TM-Vec'), each=nrow(ump_cpe)),
                     rbind(ump_spe, ump_cpe, ump_tm))

ump_df$Method <- factor(ump_df$Method,
                        levels = c('SPE', 'CPE', 'TM-Vec'))

p<-ggplot(ump_df, aes(UMAP1, UMAP2, color= globin)) +
  geom_point(alpha=.7,size=3) +
  facet_grid( ~ Method)+
  mytheme() +
  theme(strip.text.x = element_text(size = 13, face = 'bold'))
# save Fig8_new.pdf 10x5
# ------------------------
diag(dis_CPE) <- NA
gl <- c('Alpha', 'Beta')
# ---------- 1NN --------------------
im <- apply(dis_CPE,1, FUN = which.min)
res <- data.frame(source=df$globin, target=df$globin[im])
cm <- matrix(0,2,2)
colnames(cm) <- rownames(cm) <- gl
for (sf in gl) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf, names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100
pr <- round(diag(cm)/colSums(cm) , 2)*100
re <- round(diag(cm)/rowSums(cm) , 2)*100
f1 <- round((2*pr*re)/(pr+re))
rbind(ac,pr,re,f1)
```



# Spike Inter-Similarity

This chunk calculates the minimum pairwise distance among the SARS2, SARS, and MERS groups to assess their inter-similarity

```{r Spike Inter-Similarity}
source('Functions.R')
# --------------------SPE-----------
df <- readRDS("Data/rds/E210_spike.rds")
rownames(df) <- df$pdbID
x <- as.matrix(df[,-c(1:4)]/df$length)
dis_SPE <- as.matrix(x %>% proxy::dist(method = manhat))
# ----------------------------------
# -----------------CPE-------------------
df <- readRDS("Data/rds/E210.seq_spike.rds")
rownames(df) <- df$pdbID
x <- as.matrix(df[,-c(1:4)]/df$length)
dis_CPE <- as.matrix(x %>% proxy::dist(method = manhat))
# ------------------------------------------------
# -------------------Seq identity from MSA------------------------
sequences <- readAAStringSet("Data/covidPDB/Spike.fasta")
# ---- Multiple sequence alignment using ClustalW---------
alignment <- msa(sequences, method = "ClustalW")
alignment2 <- msaConvert(alignment,type="seqinr::alignment")
d <- seqinr::dist.alignment(alignment2, "identity")
dis_seqid <- as.matrix(d)
dis_seqid <- dis_seqid[df$pdbID, df$pdbID]
# -------------------------------------
# -------------RMSD---------------------
rms <- data.frame(readRDS('Data/covidPDB/RMSD_spike.rds'))
colnames(rms)<-rownames(rms)
diag(rms)<-0
rms <- as.matrix(rms)
# -------------------------------------
# -------------TM---------------------
tm <- read.csv('Data/covidPDB/disTM_vec_spike.csv')
colnames(tm) <- rownames(tm) <- df$pdbID
tm <- 1 - tm
tm_vec <- as.matrix(tm)
# -------------------------------------
# -------------TM score---------------------
spike <- read.csv("Data/covidPDB/spike_seq.csv")
df <- spike
tm <- read.csv('Data/covidPDB/disTM_score_spike.csv')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
diag(tm_max) <- 1
tm_max <- as.matrix(1 - tm_max)
# -------------Groups----------
group <- factor(df$virus)
group_indices <- split(seq_len(length(group)), group)
# -----------Function to calculate mean of pairwise distance between two groups
mean_pairwise_dis <- function(dis, gr, gr_idx){
  n <- length(unique(gr))
  calculate_mean_distance <- function(group1_indices,group2_indices,
                                     distance_matrix) {
  submatrix <- distance_matrix[group1_indices, group2_indices]
  return(mean(submatrix))
  }
mean_dis <- matrix(NA, nrow = n, ncol = n,
                   dimnames = list(levels(gr),levels(gr)))
for (i in 1:n) {
    for (j in 1:n) {
      mean_dis[i, j] <- calculate_mean_distance(gr_idx[[i]],gr_idx[[j]],dis)
    }
  }
diag(mean_dis)<-0
minmax_dis <- mean_dis
minmax_dis <- (minmax_dis - min(minmax_dis))/(max(minmax_dis) - min(minmax_dis))

minmax_dis <- round(minmax_dis,2)
return(minmax_dis)
}
# -----------------------------------------------------------
dists <- list(CPE=dis_CPE,SPE=dis_SPE,seqid=dis_seqid,
              TM_vec=tm_vec,RMSD=rms, TM_score=tm_max)
pair_dis_minPair <- lapply(dists, FUN = mean_pairwise_dis,
                           gr=group,gr_idx=group_indices)
lower_triangles <- lapply(pair_dis_minPair, function(x) x[lower.tri(x)])
mean_pair_dist <- do.call(rbind, lower_triangles)
colnames(mean_pair_dist) = c("MERS-CoV ~ SARS-CoV", "MERS-CoV ~ SARS-CoV-2", "SARS-CoV ~ SARS-CoV-2")
library(reshape2)
group_dis <- melt(mean_pair_dist)
colnames(group_dis) = c("Method","Comparison","Distance")
saveRDS(group_dis, 'Data/rds/Spike_group_dis.rds')
```

## --- Fig 10i

```{r Fig 10i}
source('Functions.R')
group_dis <- readRDS('Data/rds/Spike_group_dis.rds')
# Plot the bar plot
p0<-ggplot(group_dis, aes(x = Comparison, y = Distance, fill = Method)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7,
           show.legend = F) +
  labs(#title = "Comparison of Different Distance Metrics Between Virus Pairs",
       x = "", y = "Distance") +
  mytheme() +
  theme(legend.title = element_blank(),
        axis.text.x = element_text(size = 15, face = 'bold',
                                   color = 'black', angle = 15, 
                                   hjust = .8, vjust = .8),
        axis.text.y = element_text(size = 20, face = 'bold',
                                   color = 'black'),
        axis.title.y = element_text(size = 25, face = 'bold',
                                   color = 'black'),)+
  scale_fill_manual(values = c('magenta', 'blue','cyan','orange','red','green'))

```



# Ferritin CPE

```{r Ferritin CPE}
source('Functions.R')
ferritin <- read.csv("Data/csv/Ferritin_Like_seq.csv",sep = ",")
Nprotein <- nrow(ferritin)
E210.seq_ferritin <- data.frame(ferritin,
                            matrix(NA, ncol = 210, 
                                   nrow = Nprotein))
colnames(E210.seq_ferritin)[-c(1:4)] <- pair_inter

for (NP in 1:Nprotein) {
  print(NP)
  seq <- E210.seq_ferritin$seq[NP]
  aa210_p <- Energy_CPE210(seq)
  E210.seq_ferritin[NP,5:214] <- aa210_p
}

saveRDS(E210.seq_ferritin,file = "Data/rds/E210.seq_ferritin.rds")
```

## --- Fig 9C,E,G mean distance

```{r Fig 9C,E,G mean distance}
source('Functions.R')
# -----------------------
mean_pairwise_dis <- function(dis, gr, gr_idx){
  n <- length(unique(gr))
  calculate_mean_distance <- function(group1_indices,group2_indices,
                                      distance_matrix) {
    submatrix <- distance_matrix[group1_indices, group2_indices]
    return(mean(submatrix))
  }
  mean_dis <- matrix(NA, nrow = n, ncol = n,
                     dimnames = list(levels(gr),levels(gr)))
  for (i in 1:n) {
    for (j in 1:n) {
      mean_dis[i, j] <- calculate_mean_distance(gr_idx[[i]],gr_idx[[j]],dis)
    }
  }
  diag(mean_dis) <- 0
  minmax_dis <- mean_dis
  minmax_dis <- (minmax_dis - min(minmax_dis))/(max(minmax_dis) - min(minmax_dis))
  minmax_dis <- round(minmax_dis, 2)
  return(minmax_dis)
}
# ------------------------------------
# -------- SPE
E210_ferritin <- readRDS("Data/rds/E210_ferritin.rds")
df <- E210_ferritin
rownames(df) <- df$pdbID
dis <- as.matrix(proxy::dist(df[,-c(1:4)], method = manhat))
group <-as.factor(df$group)
group_indices <-  split(seq_len(length(group)), group)
PWdisGroup<-mean_pairwise_dis(as.matrix(dis),
                             gr = group, gr_idx = group_indices)
tree_data <- ape::bionj(as.dist(PWdisGroup))

t_SPE <- ggtree(tree_data, layout = 'unrooted',
                size=5,aes(color = label)) +
  geom_tiplab(aes(label=label, col=label),
              hjust=.5,vjust=-.9,size=4,fontface="bold",align=F)+
  scale_color_discrete(type =  c('red',"orange2","yellow4","green3",
                                 'skyblue3','blue',
                                 'magenta','purple2'
  ))+
  theme(legend.position = 'none')
# ------------------------------
# ---------- CPE
E210.seq_ferritin <- readRDS("Data/rds/E210.seq_ferritin.rds")
df <- E210.seq_ferritin
rownames(df) <- df$pdbID
dis <- as.matrix(proxy::dist(df[,-c(1:4)], method = manhat))
group <- as.factor(df$group)
group_indices <- split(seq_len(length(group)), group)
PWdisGroup <- mean_pairwise_dis(as.matrix(dis),
                                gr = group, gr_idx = group_indices)
tree_data <- ape::bionj(as.dist(PWdisGroup))

t_CPE <- ggtree(tree_data, layout = 'unrooted',
                size=5,aes(color = label)) +
  geom_tiplab(aes(label=label, col=label),
              hjust=.5,vjust=-.9,size=4,fontface="bold",align=F)+
  scale_color_discrete(type =  c('red',"orange2","yellow4","green3",
                                 'skyblue3','blue',
                                 'magenta','purple2'
  ))+
  theme(legend.position = 'none')
# ----------------------
# --------- TM
df <- read.csv('Data/csv/Ferritin_Like_seq.csv')
dis <- read.csv('Data/csv/disTM_vec_Ferritin_Like_seq.csv')
dis <- 1 - dis
colnames(dis) <- rownames(dis) <- df$pdbID
group <- as.factor(df$group)
group_indices <- split(seq_len(length(group)), group)
PWdisGroup <- mean_pairwise_dis(as.matrix(dis),
                                gr = group, gr_idx = group_indices)
tree_data <- ape::bionj(as.dist(PWdisGroup))

t_TM <- ggtree(tree_data, layout = 'unrooted',
               size=5,aes(color = label)) +
  geom_tiplab(aes(label=label, col=label),
              hjust=.5,vjust=-.9,size=4,fontface="bold",align=F)+
  scale_color_discrete(type =  c('red',"orange2","yellow4","green3",
                                 'skyblue3','blue',
                                 'magenta','purple2'
  ))+
  theme(legend.position = 'none')
```

## --- Table 3 Rho Spearman Rank

```{r Table 3 Rho Spearman Rank}
rm(list=ls())
get_ranks <- function(order, reference_order) {
  ranks <- match(order, reference_order)
  ranks[is.na(ranks)] <- NA 
  return(ranks)
}
# ----------------------------
# ----  a.25.1.1 family
# Define tree orders
reference_order <- c("R", "F", "B", "D")
SPE_order <- c("R", "F", "B", "D")
CPE_order <- c("R", "F", "D", "B")
TM_order <- c("R", "D", "B", "F")

# Compute ranks
reference_ranks <- get_ranks(reference_order, reference_order)
SPE_ranks <- get_ranks(SPE_order, reference_order)
CPE_ranks <- get_ranks(CPE_order, reference_order)
TM_ranks <- get_ranks(TM_order, reference_order)

# Calculate Spearman's rank correlation coefficient
SPE <- cor(reference_ranks, SPE_ranks, 
           method = "spearman", use = "complete.obs")
CPE <- cor(reference_ranks, CPE_ranks, 
           method = "spearman", use = "complete.obs")
TM <- cor(reference_ranks, TM_ranks, 
          method = "spearman", use = "complete.obs")
a.25.1.1 <- c(SPE, CPE, TM)
# -------------------------------
# ----  a.25.1.2 family
# Define tree orders
reference_order <- c("F", "R", "A", "B")
SPE_order <- c("R", "F", "B", "A")
CPE_order <- c("R", "F", "B", "A")
TM_order <- c("B", "R", "F", "A")

reference_ranks <- get_ranks(reference_order, reference_order)
SPE_ranks <- get_ranks(SPE_order, reference_order)
CPE_ranks <- get_ranks(CPE_order, reference_order)
TM_ranks <- get_ranks(TM_order, reference_order)

# Calculate Spearman's rank correlation coefficient
SPE <- cor(reference_ranks, SPE_ranks, 
           method = "spearman", use = "complete.obs")
CPE <- cor(reference_ranks, CPE_ranks, 
           method = "spearman", use = "complete.obs")
TM <- cor(reference_ranks, TM_ranks, 
          method = "spearman", use = "complete.obs")
a.25.1.2 <- c(SPE, CPE, TM)

cbind(Method=c('SPE', 'CPE', 'TM'),
      a.25.1.1, a.25.1.2)
```






# Length Vs Energy

```{r Length Vs Energy}
source('Functions.R')
# ----------------------------------------------------
df_seq <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df_str <- readRDS("Data/rds/E210.astral_40.rds") 

result <- mapply(function(x, y) manhat(x, y),
                 split(df_seq[,-c(1:8)]/df_seq$length, 1:nrow(df_seq)), 
                 split(df_str[,-c(1:8)]/df_str$length, 1:nrow(df_str)))

res <- data.frame(length = df_seq$length,dist = result)

result <- mapply(function(x, y) manhat(x,y),
                 split(df_seq[,-c(1:8)]/2, 1:nrow(df_seq)), 
                 split(df_str[,-c(1:8)], 1:nrow(df_str)))

res <- data.frame(scopeID=df_seq$scopeID,
                 length = df_seq$length,
                 disManhat = result
                 )
result <- mapply(function(x, y) cor(as.numeric(x), as.numeric(y)),
                 split(df_seq[,-c(1:8)]/2, 1:nrow(df_seq)), 
                 split(df_str[,-c(1:8)], 1:nrow(df_str)))
res$corr <- result
result <- mapply(function(x, y) cosine(as.numeric(x), as.numeric(y)),
                 split(df_seq[,-c(1:8)]/2, 1:nrow(df_seq)), 
                 split(df_str[,-c(1:8)], 1:nrow(df_str)))

res$cosine <- result
df_tot <- data.frame(scopeID=df_seq$scopeID,
                     CPE=rowSums(df_seq[,-c(1:8)]),
                     SPE=rowSums(df_str[,-c(1:8)]))

df_tot$disTot <- (df_tot$CPE/2000 - df_tot$SPE/1000)
bins <- c(seq(0, 500, by = 100), 1700)
res$length_bins <- cut(res$length, breaks = bins,
                       include.lowest = TRUE)
# ----------------------------------------------------
astral40 <- readRDS("Data/rds/astral_40.rds")
#-----
calculate_entropy <- function(protein_sequence) {
  aa_vector <- s2c(protein_sequence)
  aa_counts <- table(aa_vector)
  l <- sum(aa_counts) # length(aa_vector); nchar(protein_sequence)
  probs <- aa_counts / l
  p2 <- probs^2
  e1 <- 1 - (sum(p2)) # simpson diversity 
  e11 <- ((l * (sum(p2))) - 1)/(l - 1) # unbiased simpson
  e2 <- -sum(probs * log2(probs)) # shannon
  e22 <- e2 + ((length(aa_counts) - 1) / (2*l)) # unbiased shannon
  entropy_value <- c(e1, e2, e11, e22)
  names(entropy_value) <- c('simpson', 'shannon',
                            'simpsonAdjusted', 'shannonAhjusted')
  return(entropy_value)
}

entropyScore <- data.frame(scopeID=astral40$scopeID,
                        t(sapply(astral40$seq, calculate_entropy)),
                        row.names = NULL)

res <- left_join(res, df_tot, 'scopeID')
res <- left_join(res, entropyScore, 'scopeID')
# ------------------------------------
disDim <- df_seq[,-c(1:8)]/2000 - df_str[,-c(1:8)]/1000
colnames(disDim) <- colnames(df_seq)[-c(1:8)]
res <- data.frame(res, disDim)
saveRDS(res, 'Data/rds/Length_Vs_Energy.rds')
```

## --- Fig S1 210Cor

```{r Fig S1 210Cor}
source('Functions.R')
res <- readRDS('Data/rds/Length_Vs_Energy.rds')
res <- res[!is.na(res$length),-c(1,3:13)]
res <- res[-4383,]
# -- save plots
st <- seq(1,210,35)
en <- seq(35,210,35)

for (i in 1:6) {
  print(i)
  s <- st[i]+1
  e <- en[i]+1
  df <- res[,c(1, s:e)]
  df2 <- df %>%
    gather(key = "Int_i", value = "Value", -length)
  p <- ggplot(df2, aes(length, Value))+
    geom_point()+
    stat_cor(aes(label = ..r.label..),
             method = 'spearman', col='red', geom = "label",
             label.x = 0, label.y = range(df2$Value,na.rm = T)[2]+.05)+
    facet_wrap( ~ Int_i, ncol = 5)+
    ylab('CPE - SPE') +
    ylim(range(df2$Value,na.rm = T)[1]-.1, range(df2$Value,na.rm = T)[2]+.1)+
    theme_bw(base_line_size = .1)+
    theme(strip.text.x = element_text(size = 13),
          axis.title.x = element_text(size = 20),
          axis.title.y = element_text(size = 20),
          panel.grid.major = element_line(color = "black"),
    panel.grid.minor = element_line(color = "black"))
  ggsave(filename = paste0('manuscript/Revised/sup_Fig/210Cor', i, '.png'), 
         plot = p, width = 9, height = 13, 
         dpi = 600, device = "png")
}
```

# Scalability

```{r Scalability}
source('Functions.R')
# ----------------------------
path <- 'Data/csv/'
astral <- paste0(path,
                 'Astral95_subset_',
                 c(1,seq(5,30,5)),'k.csv')


df <- data.frame(subset=1:7,
                 n_protein=c(1,seq(5,30,5))*1000,
                 sumAA=NA,
                 time=NA)


for (i in 1:nrow(df)) {
  print(i)
  df2 <- read.csv(astral[i])
  tictoc::tic()
  x <- lapply(as.list(df2$seq), Energy_CPE210)
  x <- do.call(rbind, x)
  dis <- x %>% proxy::dist(method = manhat)
  z <- tictoc::toc()
  df$time[i] <- z$toc - z$tic
  df$sumAA[i] <- sum(nchar(df2$seq))
  rm(df2, dis)
}

write.csv(df, 'Data/csv/CPE_prfc_astral95.csv', row.names = F)
```

## --- Fig 14 
```{r Fig 14}
source('Functions.R')
# ---------------
cpe <- read.csv('Data/csv/CPE_prfc_astral95.csv')
tm <- read.csv('Data/csv/TM_prfc_astral95.csv')
cpe$method <- 'CPE'
tm$method <- 'TM-Vec'

df <- rbind(cpe, tm)

p<-ggplot(df, aes(n_protein, time/sumAA, col=method)) +
  geom_point(size=5, alpha=1) +
  geom_smooth(method = "lm", se = FALSE, alpha=1,linewidth = 1) +  
    annotation_custom(
    grob = textGrob(bquote(paste("T/AA = 1.04 × 10"^"-8",
                                 " N + 1.36 × 10"^"-5")),
                    gp = gpar(col = "magenta", fontsize = 15)),
    xmin = 10000, xmax = 10000, ymin = 0.0003, ymax = 0.0003)+
  annotation_custom(
    grob = textGrob(bquote(paste("T/AA = 2.33 × 10"^"-8",
                                 " N + 4.71 × 10"^"-4")),
                    gp = gpar(col = "orange", fontsize = 15)),
    xmin = 10000, xmax = 10000, ymin = 0.001, ymax = 0.001)+
  xlab('N Protein')+
  ylab('Time/AminoAcid (Sec/AA)') +
  scale_color_manual(values = c('magenta', 'orange'))+
  mytheme()+
  theme(legend.position = c(.85,.13),
        legend.text = element_text(face = 'bold'),
        axis.title.y = element_text(size = 13, vjust = 2),
        axis.title.x = element_text(size = 13, vjust = -.5))+
  scale_x_continuous(breaks = unique(df$n_protein),
                     labels = label_number(scale = 1e-3))+
  scale_y_continuous(breaks = seq(0,1.2, .2)/1000,
                     labels = label_number(scale = 1e3))+
  annotation_custom(
  grob = textGrob(bquote("×10"^-3),
                  gp = gpar(col = "blue", fontsize = 15),rot=90),
  xmin = -3100, xmax = -3100, ymin = 0.00096, ymax = 0.00096) +
  annotation_custom(
  grob = textGrob(bquote("×10"^3),
                  gp = gpar(col = "blue", fontsize = 15)),
  xmin = 19000, xmax = 19000, ymin = -.00012, ymax = -.00012) +
  coord_cartesian(clip = "off") 

ggarrange(NULL,p,ncol = 2,widths = c(.01,1))
# save Fig13_new.pdf 7x6
```



# SPE for Ct & Ho
this chunk has run on win 10 with 2.4 GHz cpu and 8 GB RAM.
```{r SPE for Ct & Ho}
source('Functions.R')
# ----------------------------------------------------
df <- read.csv('Data/csv/CT_Ho_cathID_filtered.csv')

E210_CT_Ho <- data.frame(df,
                         matrix(NA, ncol = 210, nrow = nrow(df)))

colnames(E210_CT_Ho)[-c(1:9)] <- pair_inter

tictoc::tic()
for (NP in 1:nrow(E210_CT_Ho)) {
  print(NP)
  pdbname <- substr(E210_CT_Ho$pdbID[NP],1,4)
  tryCatch({
    pdb0 <- read.pdb(pdbname, verbose = FALSE)
    sele1 <- atom.select(pdb0,"protein",type = "ATOM",
                         chain=substr(E210_CT_Ho$pdbID[NP],5,5))
    pdb0 <- trim.pdb(pdb0, sele1, verbose = FALSE)
    sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
    sele4 <- atom.select(pdb0, "noh")
    # ------------
    r <- unique(pdb0$atom$resno)
    pos <- as.numeric(unlist(strsplit(E210_CT_Ho$position[NP],'-')))
    st <- pos[1]
    en <- ifelse(pos[2]>length(r), length(r), pos[2])
    sele3 <- atom.select(pdb0,  resno=r[st]:r[en], verbose=FALSE)
    sele <- combine.select(sele2, sele4, operator="AND")
    new_pdb <- trim.pdb(pdb0, sele,verbose = FALSE)
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    E210_CT_Ho[NP,-c(1:9)] <- energy210
    }, error = function(e) {
     cat("Error downloading file:", e$message, "\n")
    })
}
dis <- as.matrix(E210_CT_Ho[,-c(1:9)] %>% proxy::dist(method = manhat))
rt <- tictoc::toc()


saveRDS(E210_CT_Ho,'Data/rds/E210_CT_Ho.rds')

diag(dis) <- NA
im <- apply(dis,1, FUN = which.min)
res <- data.frame(source=df$cathID, target=df$cathID[im])
## ----------
twoSF <- unique(E210_CT_Ho$cathID)
cm <- matrix(0,2,2)
colnames(cm) <- rownames(cm) <- twoSF
for (sf in twoSF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf,names(z)]<-z
}
ac <- round(sum(diag(cm))/sum(cm),2)*100

print(paste0('Accuracy = ', ac, '; RunningTime = ', rt$toc - rt$tic))
# time  = 187 Sec
```

## --- Fig 6 regenerat

```{r Fig 6 regenerat}
source('Functions.R')
# -----------------------------------
# time_for_SPE  = 187 Sec
# accuracy_for_SPE = 99
# Extracted from 'SPE for Ct_Ho' chunk
# ----------------------------------------------------
df <- data.frame(method=c('GR-Align','RMSD','TM-Score',
                          'YH(10Rotation)','YH(2500Rotation)','TM-Vec','CPE',
                          'SPE'),
                 Accuracy=c(62.3, 59.2, 61.5, 70.8, 81.5, 100, 100,
                            99),
                 TimeS=c(120, 3600, 33600, 600, 18600, 67, 1,
                         187))
# ------------------------------------------------------------------------
# ---------   the values for  `GR-Align`, `RMSD`, `TM-Score`, `YH(10Rotation)`, `YH(2500Rotation)` 
# ----------      were previously reported in the `Yau.S et.al. Journal of Biomolecular Structure and Dynamics (2018)`.
# --------------------------------------------------------------------------
df$Time <- round((df$TimeS*100)/(12*3600),5)
df$ratio<-log10(df$Accuracy/df$Time+1)

df <- df[order(df$ratio, decreasing = T),]
df$method <- factor(df$method, 
                    levels = df$method)
mycol <-c('magenta','orange','cyan','skyblue3','purple','red','yellow4','green')


p12h <- ggplot(df, aes(x = method, y = Time, fill= method)) +
  geom_bar(stat="identity")+
  coord_polar(theta="y") +
  theme_light(base_rect_size = 0,base_line_size = 1)+
  theme(axis.text = element_blank(),
        axis.ticks=element_blank(),
        axis.title = element_blank(),
        legend.title = element_blank(),
        #legend.position = 'none'
        )+
  scale_fill_manual(values = mycol)+
  ylim(0,100)

p200s <- p12h+xlim(c('CPE','TM-Vec','GR-Align','SPE'))+
  ylim(0,.465)+ #3.0*12*3.6 = 200sec
  theme(legend.text = element_text(face = 'bold',size = 15))

df2 <- df
df2$Time <- df2$TimeS+1
p <- ggplot(df2,aes(Accuracy,Time,col=method,label=method))+
  geom_point(size=7,show.legend = F)+    
  geom_text(show.legend = F,vjust=.7,hjust=1.2,col='black',size=6, fontface='bold')+
  mytheme()+ylab('Time (s)')+
  scale_color_manual(values = mycol)+
  scale_y_log10()+xlim(50,103)+
  theme(axis.text.x = element_text(face = 'bold',color = 'black',size = 20),
        axis.text.y = element_text(face = 'bold',color = 'black',size = 20))
# --------------------------------------------------------------------------
```


# SPE for 5SF

```{r SPE Five superfamily}
source('Functions.R')
# ----------------------------------------------------
df5 <- read.csv('Data/csv/fiveSF.csv')
Nprotein <- nrow(df5)
#----------------------------------------------
num_columns <- 210
E210_df5 <- data.frame(df5,
                       matrix(NA,ncol=num_columns,nrow=Nprotein))

colnames(E210_df5)[-c(1:9)] <- pair_inter
tictoc::tic()
for (NP in 1:Nprotein) {
  print(NP)
  chain_resno <- split_position(E210_df5$position[NP])
  pdbname <- E210_df5$pdbID[NP]
  tryCatch({
    pdb0 <- read.pdb(pdbname,verbose = FALSE)
    pdblist = list()
    for (ind in 1:dim(chain_resno)[1]){
      sele1 <- atom.select(pdb0,"protein",type = "ATOM",
                           chain=chain_resno$chain[ind])
      sele2 <- atom.select(pdb0, "protein", elety=c("H","OXT"),inverse=TRUE)
      sele4 <- atom.select(pdb0, "noh")
      sele <- combine.select(sele1, sele2,sele4, operator="AND",verbose = FALSE)
      if (!(chain_resno$start[ind]=="NA") & !(chain_resno$end[ind])=="NA"){
         st <- chain_resno$start[ind]
         en <- chain_resno$end[ind]
         sele3 <- atom.select(pdb0,  resno=st:en, verbose=FALSE)
         sele <- combine.select(sele1,sele2,sele3,sele4,operator="AND",verbose = FALSE)
      }
      pdblist[[ind]] <- trim.pdb(pdb0, sele,verbose = FALSE)
    }
    new_pdb = pdblist[[1]]
    if (dim(chain_resno)[1] > 1) {
      for (ind in 2:dim(chain_resno)[1]){
      new_pdb <- cat.pdb(new_pdb, pdblist[[ind]], rechain=FALSE)
      }
    }
    Net_Frame <- NetworkFrame(PDB = new_pdb)
    energy210 <- Energy_PC210(Net_Frame,energy_dell_dunbrack)
    E210_df5[NP,-c(1:9)] <- energy210
    }, error = function(e) {
     cat("Error downloading file:", e$message, "\n")
    })
}
df2 <- E210_df5
df2 <- df2[!is.na(df2$FF),]
dis <- as.matrix(proxy::dist(df2[,-c(1:9)], method = manhat))
tictoc::toc()
# ---------------------------------
# t = 3524 ----------------
#saveRDS(E210_df5, file = "Data/rds/E210_fiveSF.rds")
```

## --- Table 2 kNN & RF

```{r Table 2 kNN & RF}
source('Functions.R')
# ----------------------SPE------------------------------
# -------- 5 sf
win <- 'a.4.5'
imu <- 'b.1.1'
ph <- 'b.55.1'
ub <- 'd.15.1'
ntf <- 'd.17.4'

fiveSF <- c(win,imu,ph,ub,ntf)
#############
df5 <- readRDS('Data/rds/E210_fiveSF.rds')
df5 <- df5[!is.na(df5$FF),]
# ----------------------------------------
# ---------- 1NN ----------------
# ---------------------------------------
dis <- as.matrix(proxy::dist(df5[,-c(1:9)], method = manhat))
diag(dis) <- NA

im <- apply(dis, 1, FUN = which.min)
res <- data.frame(source=df5$superfamily, target=df5$superfamily[im])
cm <- matrix(0,5,5)
colnames(cm) <- rownames(cm) <- fiveSF
for (sf in fiveSF) {
  x <- res[res$source%in%sf,]
  z <- table(x$target)
  cm[sf,names(z)]<-z
}
Accuracy<-sum(diag(cm))/sum(cm)
Precision <- diag(cm)/colSums(cm)
Recall <- diag(cm)/rowSums(cm)
F1 <- (2 * Precision * Recall) /(Precision + Recall)

res1NN_SPE<-data.frame(t(round(c(Accuracy,F1),2)))
# ----------------------------------------
# ---------- 10 fold cross validation Random forest ----------------
# ---------------------------------------
set.seed(12345)
df5$superfamily <- factor(df5$superfamily)
kfolds <- createFolds(df5$superfamily, k = 10)
res<-c()
for (i in 1:10) {
  print(i)
  x <- kfolds[[i]]
  tr <- df5[-x,c(7, 10:219)]
  te <- df5[x,c(7, 10:219)]
  rf = randomForest(superfamily~.,data = tr)
  p2 <- predict(rf, te)
  cm2 <- confusionMatrix(p2, te$superfamily)
  Accuracy <- c(cm2$overall['Accuracy'], F1=cm2$byClass[,'F1'])
  res<-rbind(res,Accuracy)
}
res <- rbind(res,colMeans(res))
res <- round(res,2)
rownames(res) <- c(paste0("Fold_",1:length(kfolds)),'Average')
colnames(res)[-1] <- gsub('.Class','',colnames(res)[-1])
resRF_SPE <- res[11,]
# -----------------
res_final <- rbind(res1NN_SPE, resRF_SPE)
colnames(res_final) <- colnames(res)
```

