---
title: "supplemntary"
author: "peyman"
date: "2024-04-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages

```{r}
library(bio3d)
library(mclust)
library(tidyverse)
```

# Covid-19
## RMSD
```{r}
spike <- read.csv("Data/covidPDB/spike200.csv", sep=";")
spike <- spike[-grep('6XR8',spike$pdbID),] # There is no PDB file of ID 6XR8
spike <- spike[spike$Conformation%in%'Close',]
Np <- nrow(spike)
#----------------------------------------------
rms <- matrix(NA,Np,Np)

tictoc::tic()
for (i in 1:Np) {
  print(i)
  tryCatch({
    chi <- substr(spike$pdbID[i],5,5)
    pdbnamei <- substr(spike$pdbID[i],1,4)
    pdb0 <- read.pdb(tolower(pdbnamei))
    sele <- atom.select(pdb0,chain=chi)
    new_pdbi <- trim.pdb(pdb0, sele,verbose = FALSE)
    for (j in 1:Np) {
      if(i>j){
        chj <- substr(spike$pdbID[j],5,5)
        pdbnamej <- substr(spike$pdbID[j],1,4)
        pdb0 <- read.pdb(tolower(pdbnamej))
        sele <- atom.select(pdb0,'protein',chain=chj)
        new_pdbj <- trim.pdb(pdb0, sele,verbose = FALSE)
        pdbs <- list(new_pdbi, new_pdbj)
        aln_pdbs <- pdbaln(pdbs,fit = T,)
        xyz <- pdbfit(aln_pdbs)
        rms[i,j] <- rms[j,i] <- rmsd(xyz)[1,2]
      }
    }
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
file.remove('aln.fa')
tictoc::toc()
rownames(rms) <- colnames(rms) <- spike$pdbID
saveRDS(rms,'Data/covidPDB/disRMSD.rds')

```

## plot RMSD

```{r}
spike <- read.csv("Data/covidPDB/spike200.csv", sep=";")
spike <- spike[-grep('6XR8',spike$pdbID),] # There is no PDB file of ID 6XR8
spike <- spike[spike$Conformation%in%'Close',]
df <- spike

rms <- data.frame(readRDS('Data/covidPDB/disRMSD.rds'))
diag(rms)<-0

hc <- as.dist(rms)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), spike$VIRUS)
classError(cutree(hc, 3), spike$VIRUS)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$VIRUS)), ]
rn <- df$pdbID
tree_data <- as.phylo(hc)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))
```

## TM score

```{r}
spike <- read.csv("Data/covidPDB/spike200.csv", sep=";")
spike <- spike[-grep('6XR8',spike$pdbID),] # There is no PDB file of ID 6XR8
spike <- spike[spike$Conformation%in%'Close',]
df <- spike
tm <- read.csv('Data/covidPDB/disTM.csv',row.names = 'X')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
#tm1 <- tm2 <- tm
#tm1[lower.tri(tm1)]<-0
#tm2[upper.tri(tm2)]<-0

#tm1 <- tm1 + t(tm1)
#tm2 <- tm2 + t(tm2)

tm_vec <- read.csv('Data/csv/disTM_vec.csv',row.names = 'X')
colnames(tm_vec) <- rownames(tm_vec) <- spike$pdbID
tm_vec <- 1 - tm_vec

hc <- as.dist(tm_vec)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 5), spike$VIRUS)
classError(cutree(hc, 3), spike$VIRUS)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$VIRUS)), ]
rn <- df$pdbID
tree_data <- as.phylo(hc)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))


labcol <- c("green3", "blue", "red")
ord_sml <- spike[,][order.dendrogram(dend),2]
group_cols <- labcol[as.factor(ord_sml)]

dend2 <- dend %>%
  #color_branches(k=3, col = c("red","blue","green3")) %>%
  color_labels(col =   group_cols) %>%
  set("labels_cex", 0.5) 

plot(dend2, ylab = "Height")

legend("topright", legend = as.character(unique(ord_sml)),
       pch = 15, pt.cex = 2.3, cex = 1.4, bty = 'n',
       inset = c(-.3, -.5), # place outside
       col = unique(group_cols),horiz = FALSE,xpd = TRUE)

```

# cor SPE&CPE

```{r}
# astral 40
df_seq <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df_seq = df_seq[!is.na(df_seq$FL),] 

df_str <- readRDS("Data/rds/E210.astral_40.rds") 
df_str = df_str[!is.na(df_str$FL),] 
m<-match(df_str$scopeID,df_seq$scopeID)
df_str <- df_str[-which(is.na(m)),]


str <- t(df_str[,-c(1:8)])
seq <- t(df_seq[,-c(1:8)])

corr <- cor(str,seq)
csin <- cosine(cbind(str,seq)) #lsa package
n<-ncol(str)
dim(csin)[1]==2*n
csin <- csin[1:n, (n+1):(2*n)]
dim(csin)
hist(corr[lower.tri(corr,diag = TRUE)])
hist(csin)
quantile(corr)
```

