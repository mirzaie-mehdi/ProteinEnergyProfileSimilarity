---
title: "supplemntary"
author: "peyman"
date: "2024-04-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages

```{r}
library(bio3d)
library(mclust)
library(tidyverse)
library(reshape2)
library(phylotools)
```

# Covid-19
## RMSD
```{r}
spike <- read.csv("Data/covidPDB/spike_close.csv")
Np <- nrow(spike)
#----------------------------------------------
rms <- matrix(NA,Np,Np)

tictoc::tic()
for (i in 1:Np) {
  print(i)
  tryCatch({
    chi <- substr(spike$pdbID[i],5,5)
    pdbnamei <- substr(spike$pdbID[i],1,4)
    pdb0 <- read.pdb(tolower(pdbnamei))
    sele <- atom.select(pdb0,chain=chi)
    new_pdbi <- trim.pdb(pdb0, sele,verbose = FALSE)
    for (j in 1:Np) {
      if(i>j){
        chj <- substr(spike$pdbID[j],5,5)
        pdbnamej <- substr(spike$pdbID[j],1,4)
        pdb0 <- read.pdb(tolower(pdbnamej))
        sele <- atom.select(pdb0,'protein',chain=chj)
        new_pdbj <- trim.pdb(pdb0, sele,verbose = FALSE)
        pdbs <- list(new_pdbi, new_pdbj)
        aln_pdbs <- pdbaln(pdbs,fit = T,)
        xyz <- pdbfit(aln_pdbs)
        rms[i,j] <- rms[j,i] <- rmsd(xyz)[1,2]
      }
    }
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
file.remove('aln.fa')
tictoc::toc()
rownames(rms) <- colnames(rms) <- spike$pdbID
saveRDS(rms,'Data/covidPDB/RMSD.rds')

```

## plot RMSD

```{r}
spike <- read.csv("Data/covidPDB/spike_close.csv")

rms <- data.frame(readRDS('Data/covidPDB/RMSD.rds'))
diag(rms)<-0

hc <- as.dist(rms)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), spike$virus)
classError(cutree(hc, 3), spike$virus)
dend <- hc %>% as.dendrogram

df <- spike
df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
tree_data <- as.phylo(hc)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))
```

## TM score

```{r}
spike <- read.csv("Data/covidPDB/spike_close.csv")
df <- spike

tm <- read.csv('Data/covidPDB/TM_Score.csv')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}


tm_vec <- read.csv('Data/covidPDB/disTM_vec.csv')
colnames(tm_vec) <- rownames(tm_vec) <- spike$pdbID
tm_vec <- 1 - tm_vec

hc <- as.dist(tm_vec)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 5), spike$virus)
classError(cutree(hc, 5), spike$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
tree_data <- as.phylo(dend)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(#legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))


labcol <- c("blue","green","red" )
ord_sml <- spike[,][order.dendrogram(dend),3]
group_cols <- labcol[as.factor(ord_sml)]

dend2 <- dend %>%
  #color_branches(k=3, col = c("red","blue","green3")) %>%
  color_labels(col =   group_cols) %>%
  set("labels_cex", 0.5) 

plot(dend2, ylab = "Height")

legend("topright", legend = as.character(unique(ord_sml)),
       pch = 15, pt.cex = 2.3, cex = 1.4, bty = 'n',
       inset = c(-.3, -.5), # place outside
       col = unique(group_cols),horiz = FALSE,xpd = TRUE)

```

# cor SPE&CPE

```{r}
# astral 40
df_seq <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df_seq = df_seq[!is.na(df_seq$FL),] 

df_str <- readRDS("Data/rds/E210.astral_40.rds") 
df_str = df_str[!is.na(df_str$FL),] 
m<-match(df_str$scopeID,df_seq$scopeID)
df_str <- df_str[-which(is.na(m)),]


str <- t(df_str[,-c(1:8)])
seq <- t(df_seq[,-c(1:8)])

corr <- cor(str,seq)
quantile(diag(corr))
hist(diag(corr))

n <- ncol(seq)
csin <- rep(NA,n)
corr <- rep(NA,n)
for (i in 1:n) {
  print(i)
  x <- seq[,i]
  y <- str[,i]
  csin[i] <- cosine(x,y) #lsa package
  corr[i] <- cor(x,y)
}

df <- data.frame(corr,csin)
df <- melt(df)
df_med <- aggregate(.~variable,df,median)
df_med$value <- round(df_med$value,2)


p <- ggplot(df, aes(value, fill=variable))+
  geom_density(alpha=.5)+
  mytheme()+
  theme(legend.position = c(.1,.9))+
  xlab('')+ylab('')+
  geom_text(data = df_med, aes(x=value, y=c(4,5), label = value, 
                               col=variable), size=8)+
  scale_fill_discrete(name = "variable", labels = c("Correlation", "Cosine"))+
  scale_color_discrete(name = "variable", labels = c("Correlation", "Cosine"))
# save pdf 8x10
```

# bacteriocine 

```{r}
bac <- read.csv('Data/csv/Bacteriocin.csv')
tm0 <- readRDS('Data/rds/bacteriocin_tm_vec.rds')
tm <- read.csv('Data/csv/TM_vec_bac.csv')
colnames(tm) <- rownames(tm) <- bac$ID
tm <- melt(as.matrix(tm))
colnames(tm)[1:2] <- c('ID_x','ID_y')
tm0 <- left_join(tm0,tm,c('ID_x','ID_y'))
```
# ferritin

```{r}
source('mytheme.R')
df <- read.csv('Data/csv/Ferritin_Like_seq.csv')
df <- df[df$length!=0,]

dis <- read.csv('Data/csv/disTM_vec_Ferritin_Like_seq.csv')
colnames(dis) <- rownames(dis) <- df$pdbID
dis <- 1 - dis
dis <- as.dist(dis)


df <- df[with(df, order(df$group)),]
rn <- df$pdbID
rownames(df) <- rn
grp <- list(Bacteri     = rn[1:5],
            BMM_alpha = rn[6:7],
            BMM_beta  = rn[8:9],
            Dps  = rn[10:24],
            Fatty_acid  = rn[25:28],
            Ferritins  = rn[29:39],
            RNRR2  = rn[40:47],
            NAA  = rn[48:52])


tree_data <- ape::bionj(dis)

p_data <- ggtree(tree_data, layout = 'circular',
                 branch.length='none',size = 1.5) 

p<-groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(#legend.position="none",
        plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
  geom_tiplab2(aes(label=label,angle=angle),
               hjust=-.1,size=3.5,fontface="bold",align=F)
  

```

