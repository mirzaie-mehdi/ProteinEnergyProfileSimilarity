---
title: "supplemntary"
author: "peyman"
date: "2024-04-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages

```{r}
library(bio3d)
library(mclust)
library(tidyverse)
```

# Covid-19
## RMSD
```{r}
spike <- read.csv("Data/covidPDB/spike200.csv", sep=";")
spike <- spike[-grep('6XR8',spike$pdbID),] # There is no PDB file of ID 6XR8
spike <- spike[spike$Conformation%in%'Close',]
Np <- nrow(spike)
#----------------------------------------------
rms <- matrix(NA,Np,Np)

tictoc::tic()
for (i in 1:Np) {
  print(i)
  tryCatch({
    chi <- substr(spike$pdbID[i],5,5)
    pdbnamei <- substr(spike$pdbID[i],1,4)
    pdb0 <- read.pdb(tolower(pdbnamei))
    sele <- atom.select(pdb0,chain=chi)
    new_pdbi <- trim.pdb(pdb0, sele,verbose = FALSE)
    for (j in 1:Np) {
      if(i>j){
        chj <- substr(spike$pdbID[j],5,5)
        pdbnamej <- substr(spike$pdbID[j],1,4)
        pdb0 <- read.pdb(tolower(pdbnamej))
        sele <- atom.select(pdb0,'protein',chain=chj)
        new_pdbj <- trim.pdb(pdb0, sele,verbose = FALSE)
        pdbs <- list(new_pdbi, new_pdbj)
        aln_pdbs <- pdbaln(pdbs,fit = T,)
        xyz <- pdbfit(aln_pdbs)
        rms[i,j] <- rms[j,i] <- rmsd(xyz)[1,2]
      }
    }
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
file.remove('aln.fa')
tictoc::toc()
rownames(rms) <- colnames(rms) <- spike$pdbID
saveRDS(rms,'Data/covidPDB/disRMSD.rds')

```

## plot RMSD

```{r}
spike <- read.csv("Data/covidPDB/spike200.csv", sep=";")
spike <- spike[-grep('6XR8',spike$pdbID),] # There is no PDB file of ID 6XR8
spike <- spike[spike$Conformation%in%'Close',]
df <- spike

rms <- data.frame(readRDS('Data/covidPDB/disRMSD.rds'))
diag(rms)<-0

hc <- as.dist(rms)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), spike$VIRUS)
classError(cutree(hc, 3), spike$VIRUS)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$VIRUS)), ]
rn <- df$pdbID
tree_data <- as.phylo(hc)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))
```

## TM score

```{r}
spike <- read.csv("Data/covidPDB/spike200.csv", sep=";")
spike <- spike[-grep('6XR8',spike$pdbID),] # There is no PDB file of ID 6XR8
spike <- spike[spike$Conformation%in%'Close',]
df <- spike
tm <- read.csv('Data/covidPDB/disTM.csv',row.names = 'X')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
#tm1 <- tm2 <- tm
#tm1[lower.tri(tm1)]<-0
#tm2[upper.tri(tm2)]<-0

#tm1 <- tm1 + t(tm1)
#tm2 <- tm2 + t(tm2)

tm_vec <- read.csv('Data/csv/disTM_vec.csv',row.names = 'X')
colnames(tm_vec) <- rownames(tm_vec) <- spike$pdbID
tm_vec <- 1 - tm_vec

hc <- as.dist(tm_vec)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 5), spike$VIRUS)
classError(cutree(hc, 3), spike$VIRUS)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$VIRUS)), ]
rn <- df$pdbID
tree_data <- as.phylo(hc)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))


labcol <- c("green3", "blue", "red")
ord_sml <- spike[,][order.dendrogram(dend),2]
group_cols <- labcol[as.factor(ord_sml)]

dend2 <- dend %>%
  #color_branches(k=3, col = c("red","blue","green3")) %>%
  color_labels(col =   group_cols) %>%
  set("labels_cex", 0.5) 

plot(dend2, ylab = "Height")

legend("topright", legend = as.character(unique(ord_sml)),
       pch = 15, pt.cex = 2.3, cex = 1.4, bty = 'n',
       inset = c(-.3, -.5), # place outside
       col = unique(group_cols),horiz = FALSE,xpd = TRUE)

```
# tree bac

```{r}
tm <- readRDS('Data/rds/bacteriocin_tm_vec.rds')
tm$ID_x <- as.character(tm$ID_x)
tm$ID_y <- as.character(tm$ID_y)
seqIDs <- unique(c(tm$ID_x, tm$ID_y))
idx <- match(seqIDs, tm$ID_x)
idy <- match(seqIDs[is.na(idx)], tm$ID_y)
tmx <- tm[idx[!is.na(idx)], c(7,8)]
tmy <- tm[idy, c(10,11)]
colnames(tmx)<-colnames(tmy)<-c('IDs','Class')
z<-rbind(tmx,tmy)
db <- tm[,c(1,2,6)]
n <- length(seqIDs)
tmdb <- data.frame(matrix(0,n,n))
colnames(tmdb)<-rownames(tmdb)<-seqIDs

dis <- as.dist(tmdb)
hc <- dis%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 5), z$class_x)
classError(cutree(hc, 3), z$class_x)
dend <- hc %>% as.dendrogram

labcol <- c("green3", "blue", "red")
ord_sml <- z[,][order.dendrogram(dend),2]
group_cols <- labcol[as.factor(ord_sml)]

dend2 <- dend %>%
  #color_branches(k=3, col = c("red","blue","green3")) %>%
  color_labels(col =   group_cols) %>%
  set("labels_cex", 0.5) 

plot(dend2, ylab = "Height")

```

# cor SPE&CPE

```{r}
# astral 40
df_seq <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df_seq = df_seq[!is.na(df_seq$FL),] 

df_str <- readRDS("Data/rds/E210.astral_40.rds") 
df_str = df_str[!is.na(df_str$FL),] 
m<-match(df_str$scopeID,df_seq$scopeID)
df_str <- df_str[-which(is.na(m)),]


str <- t(df_str[,-c(1:8)])
seq <- t(df_seq[,-c(1:8)])

corr <- cor(str,seq)
quantile(diag(corr))
hist(diag(corr))

n <- ncol(seq)
csin <- rep(NA,n)
corr <- rep(NA,n)
for (i in 1:n) {
  print(i)
  x <- seq[,i]
  y <- str[,i]
  csin[i] <- cosine(x,y) #lsa package
  corr[i] <- cor(x,y)
}

df <- data.frame(corr,csin)
df <- melt(df)
df_med <- aggregate(.~variable,df,median)
df_med$value <- round(df_med$value,2)


p <- ggplot(df, aes(value, fill=variable))+
  geom_density(alpha=.5)+
  mytheme()+
  theme(legend.position = c(.1,.9))+
  xlab('')+ylab('')+
  geom_text(data = df_med, aes(x=value, y=c(4,5), label = value, 
                               col=variable), size=8)+
  scale_fill_discrete(name = "variable", labels = c("Correlation", "Cosine"))+
  scale_color_discrete(name = "variable", labels = c("Correlation", "Cosine"))
# save pdf 8x10
```

# bacteriocine 

```{r}
nprotein <- nrow(tm)

tictoc::tic()
for (i in 1:nprotein){
  if(i%%100==0)print(i)
  # ---- seq1
  seq <- unlist(strsplit(tolower(tm$Seq_x[i]), ""))
  freq <- c()
  for (j in 1:20){
    freq[j] <-  length(grep(tolower(letters_list[j]),seq))
  }
  freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
  en_fr <- aaenergy * freq_matrix
  en_fr <- en_fr/length(seq)
  pair_es <- diag(freq) %*% as.matrix(en_fr)
  aa210_p<-pair_es[lower.tri(pair_es,diag = T)]
  #CEP_x <- c(length(seq),aa210_p)
  CEP_x <- aa210_p
  # ---- seq2
  seq <- unlist(strsplit(tolower(tm$Seq_y[i]), ""))
  freq = c()
  for (j in 1:20){
    freq[j] <-  length(grep(tolower(letters_list[j]),seq))
  }
  freq_matrix <- matrix(rep(freq, each = 20), nrow = 20)
  en_fr <- aaenergy * freq_matrix
  en_fr <- en_fr/length(seq)
  pair_es <- diag(freq) %*% as.matrix(en_fr)
  aa210_p<-pair_es[lower.tri(pair_es,diag = T)]
  #CEP_y <- c(length(seq),aa210_p)
  CEP_y <- aa210_p
  # ----------
  tm$CEP_dis[i] <- manhat(CEP_x, CEP_y)
}
tictoc::toc()

tm$CEP_dis <- (tm$CEP_dis-min(tm$CEP_dis))/(max(tm$CEP_dis)-min(tm$CEP_dis))
tm$CEP_dis <- 1-(tm$CEP_dis) 

tm$status <- if_else(tm$class_x==tm$class_y,'same class','different class')
tm$status2 <- if_else(tm$Subclass_x==tm$Subclass_y&tm$class_x=='Class_1'&tm$class_y=='Class_1','same class(sub class1)',NA)
# saveRDS(tm,'Data/rds/bacteriocin_tm-vec.rds')
```

