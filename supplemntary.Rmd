---
  title: "supplemntary"
author: "peyman"
date: "2024-04-05"
output: html_document
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages

```{r}
library(bio3d)
library(mclust)
library(tidyverse)
library(reshape2)
library(phylotools)
library(lsa)
library(ggbreak)
```

# spike
## Fig S1

```{r}
source('Functions.R')
# ----------------------------------------------------
spike <- read.csv("Data/covidPDB/spike_seq.csv")
df <- spike
# --------------TM score-------------
tm <- read.csv('Data/covidPDB/disTM_score_spike.csv')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
tm_max <- 1 - tm_max
hc <- as.dist(tm_max)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), spike$virus)
classError(cutree(hc, 3), spike$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
tree_data <- as.phylo(dend)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'dendrogram',
                 size = 1) 

t_tmScore <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(#legend.position="none",
    plot.title = element_text(size = 17, hjust = 0.5,vjust = 0))+
  #geom_tiplab2(aes(label=label,angle=angle),
  #              hjust=-.1,size=3.5,fontface="bold",align=F)+
    geom_tiplab(aes(label=label),
               hjust=1,size=1.5,fontface="bold",align=F)+
  scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                       type =  c("blue","green","red" ))+
  ggtitle('TM-Score')
```



## Table S1

```{r}
source('Functions.R')
# ----------------------------------------------------
# -----------------CPE------------------------
df <- readRDS("Data/rds/E210.seq_spike.rds")
x <- as.matrix(df[,-c(1:5)]/df$length)
hc <- x %>% proxy::dist(method = manhat)
hc <- hc%>% hclust(method = "ward.D2")
ARI_CPE <- c()
CE_CPE <- c()
for (i in 3:6) {
  ARI_CPE <- c(ARI_CPE, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_CPE <- c(CE_CPE, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------SPE------------------------
df <- readRDS("Data/rds/E210_spike.rds")
x <- as.matrix(df[,-c(1:5)]/df$length)
hc <- x %>% proxy::dist(method = manhat)
hc <- hc %>% hclust(method = "ward.D2")
ARI_SPE <- c()
CE_SPE <- c()
for (i in 3:6) {
  ARI_SPE <- c(ARI_SPE, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_SPE <- c(CE_SPE, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------RMSD------------------------
rms <- data.frame(readRDS('Data/covidPDB/RMSD_spike.rds'))
diag(rms)<-0
hc <- as.dist(rms)
hc <- hc %>% hclust(method = "ward.D2")
ARI_RMSD <- c()
CE_RMSD <- c()
for (i in 3:6) {
  ARI_RMSD <- c(ARI_RMSD, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_RMSD <- c(CE_RMSD, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------TM-Vec------------------------
tm_vec <- read.csv('Data/covidPDB/disTM_vec_spike.csv')
colnames(tm_vec) <- rownames(tm_vec) <- df$pdbID
tm_vec <- 1 - tm_vec
hc <- as.dist(tm_vec)
hc <- hc %>% hclust(method = "ward.D2")
ARI_TM_Vec <- c()
CE_TM_Vec <- c()
for (i in 3:6) {
  ARI_TM_Vec <- c(ARI_TM_Vec, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_TM_Vec <- c(CE_TM_Vec, classError(cutree(hc, i), df$virus)$errorRate)
}
# -----------------------------------
# -----------------TM-score------------------------
tm <- read.csv('Data/covidPDB/disTM_score_spike.csv')
tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
tm_max <- 1 - tm_max
diag(tm_max) <- NA
hc <- as.dist(tm_max)
hc <- hc%>% hclust(method = "ward.D2")
ARI_TM_score <- c()
CE_TM_score <- c()
for (i in 3:6) {
  ARI_TM_score <- c(ARI_TM_score, adjustedRandIndex(cutree(hc, i), df$virus))
  CE_TM_score <- c(CE_TM_score, classError(cutree(hc, i), df$virus)$errorRate)
}
# --------------------------------
ARI_final <- rbind(ARI_CPE, ARI_SPE, ARI_RMSD, ARI_TM_Vec, ARI_TM_score,
                   CE_CPE, CE_SPE, CE_RMSD, CE_TM_Vec, CE_TM_score)
colnames(ARI_final) <- paste0('cut_tree_', 3:6)
```


