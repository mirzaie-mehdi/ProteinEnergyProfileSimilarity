---
title: "supplemntary"
author: "peyman"
date: "2024-04-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages

```{r}
library(bio3d)
library(mclust)
library(tidyverse)
library(reshape2)
library(phylotools)
```

# Covid-19
## RMSD
```{r}
spike <- read.csv("Data/covidPDB/spike_close.csv")
Np <- nrow(spike)
#----------------------------------------------
rms <- matrix(NA,Np,Np)

tictoc::tic()
for (i in 1:Np) {
  print(i)
  tryCatch({
    chi <- substr(spike$pdbID[i],5,5)
    pdbnamei <- substr(spike$pdbID[i],1,4)
    pdb0 <- read.pdb(tolower(pdbnamei))
    sele <- atom.select(pdb0,chain=chi)
    new_pdbi <- trim.pdb(pdb0, sele,verbose = FALSE)
    for (j in 1:Np) {
      if(i>j){
        chj <- substr(spike$pdbID[j],5,5)
        pdbnamej <- substr(spike$pdbID[j],1,4)
        pdb0 <- read.pdb(tolower(pdbnamej))
        sele <- atom.select(pdb0,'protein',chain=chj)
        new_pdbj <- trim.pdb(pdb0, sele,verbose = FALSE)
        pdbs <- list(new_pdbi, new_pdbj)
        aln_pdbs <- pdbaln(pdbs,fit = T,)
        xyz <- pdbfit(aln_pdbs)
        rms[i,j] <- rms[j,i] <- rmsd(xyz)[1,2]
      }
    }
  }, error = function(e) {
    cat("Error downloading file:", e$message, "\n")
  })
}
file.remove('aln.fa')
tictoc::toc()
rownames(rms) <- colnames(rms) <- spike$pdbID
saveRDS(rms,'Data/covidPDB/RMSD.rds')

```

## plot RMSD

```{r}
spike <- read.csv("Data/covidPDB/spike_close.csv")

rms <- data.frame(readRDS('Data/covidPDB/RMSD.rds'))
diag(rms)<-0

hc <- as.dist(rms)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 3), spike$virus)
classError(cutree(hc, 3), spike$virus)


df <- spike
df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
tree_data <- as.phylo(hc)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))

labcol <- c("blue","green","red" )
ord_sml <- spike[,][order.dendrogram(dend),3]
group_cols <- labcol[as.factor(ord_sml)]

dend <- hc %>% as.dendrogram
dend2 <- dend %>%
  #color_branches(k=3, col = c("red","blue","green3")) %>%
  color_labels(col =   group_cols) %>%
  set("labels_cex", .5) %>%
  set("leaves_cex", .5) %>%
  set("leaves_pch", 19) %>%
  set("leaves_col", group_cols)

plot(dend2, ylab = "Height",leaflab = "none")


```

## TM score

```{r}
spike <- read.csv("Data/covidPDB/spike_close.csv")
df <- spike

tm <- read.csv('Data/covidPDB/TM_Score.csv')
rownames(tm) <- colnames(tm) <- df$pdbID

tm_max <- tm
for (i in 1:nrow(tm_max)) {
  print(i)
  for (j in 1:nrow(tm_max)) {
    tm_max[i,j] <- max(tm_max[i,j], tm_max[j,i])
    tm_max[j,i] <- tm_max[i,j]
  }
}
tm_max <- 1 - tm_max

tm_vec <- read.csv('Data/covidPDB/disTM_vec.csv')
colnames(tm_vec) <- rownames(tm_vec) <- spike$pdbID
tm_vec <- 1 - tm_vec

hc <- as.dist(tm_vec)
hc <- hc%>% hclust(method = "ward.D2")

adjustedRandIndex(cutree(hc, 2), spike$virus)
classError(cutree(hc, 2), spike$virus)
dend <- hc %>% as.dendrogram

df <- df[with(df, order(df$virus)), ]
rn <- df$pdbID
tree_data <- as.phylo(dend)
grp <- list(MERS_Cov  = rn[1:32],
            SARS_Cov  = rn[33:63],
            SARS_Cov2 = rn[64:143])

p_data <- ggtree(tree_data, layout = 'circular',
                 size = 1) 

p <- groupOTU(p_data, grp, "groups") + aes(color=groups) +
       theme(#legend.position="none",
             plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
       geom_tiplab2(aes(label=label,angle=angle),
                    hjust=-.1,size=3.5,fontface="bold",align=F)+
       scale_color_discrete(breaks=c('MERS_Cov', 'SARS_Cov', 'SARS_Cov2'),
                            type =  c("blue","green","red" ))


labcol <- c("blue","green","red" )
ord_sml <- df[,][order.dendrogram(dend),7]
group_cols <- labcol[as.factor(ord_sml)]

dend2 <- dend %>%
  #color_branches(k=3, col = c("red","blue","green3")) %>%
  color_labels(col =   group_cols) %>%
  set("labels_cex", .5) %>%
  set("leaves_cex", .5) %>%
  set("leaves_pch", 19) %>%
  set("leaves_col", group_cols)

plot(dend2, ylab = "Height",leaflab = "none")
legend("topright", legend = as.character(unique(ord_sml)),
       pch = 15, pt.cex = 2.3, cex = 1.4, bty = 'n',
       inset = c(-.3, -.5), # place outside
       col = unique(group_cols),horiz = FALSE,xpd = TRUE)

```

# cor SPE&CPE

```{r}
# astral 40
df_seq <- readRDS("Data/rds/E210.seq_astral_40.rds") 
df_seq = df_seq[!is.na(df_seq$FL),] 

df_str <- readRDS("Data/rds/E210.astral_40.rds") 
df_str = df_str[!is.na(df_str$FL),] 
m<-match(df_str$scopeID,df_seq$scopeID)
df_str <- df_str[-which(is.na(m)),]


n <- nrow(df_seq)
csin <- rep(NA,n)
corr <- rep(NA,n)
for (i in 1:n) {
  print(i)
  x <- as.numeric(df_seq[i,-c(1:8)])
  y <- as.numeric(df_str[i,-c(1:8)])
  csin[i] <- cosine(x,y) #lsa package
  corr[i] <- cor(x,y)
}

df <- data.frame(corr,csin)
df <- melt(df)
df_med <- aggregate(.~variable,df,median)
df_med$value <- round(df_med$value,2)

source('mytheme.R')
p <- ggplot(df, aes(value, fill=variable))+
  geom_density(alpha=.5)+
  mytheme()+
  theme(legend.position = c(.2,.9))+
  xlab('')+ylab('')+
  geom_text(data = df_med, aes(x=value, y=c(4,5), label = value, 
                               col=variable), size=8)+
  scale_fill_discrete(name = "variable", labels = c("Correlation", "Cosine"))+
  scale_color_discrete(name = "variable", labels = c("Correlation", "Cosine"))
# save Cor_Cosine.pdf 7x6
```

# bacteriocine 

```{r}
tm <- readRDS('Data/rds/bacteriocin_tm_vec.rds')
tm2 <- tm[!is.na(tm$status2),-24]
colnames(tm2)[24]<-'status'
tm2 <- rbind(tm[,-25],tm2)

tm2 <- tm2[,c(5,20,21,6,23,24)] # 22~6 DeepBlast
colnames(tm2)[-6] <- c('Alphafold2','Omegafold','ESMfold','TM_vec','CPE')
#tm2[,-6] <- scale(tm2[,-6],center = T, scale = F)

tm2 <- melt(tm2,variable.name = 'method',value.name = 'score')
tm2$method <- factor(tm2$method,levels = c('TM_vec','Alphafold2','Omegafold','ESMfold','CPE'))


tm2sd <- tm2 %>% group_by(status,method) %>%
  summarise(score = score/sd(score))

tm2sd$method <- factor(tm2sd$method,levels = c('TM_vec','Alphafold2','Omegafold','ESMfold','CPE'))

p <- ggplot(tm2sd,aes(status,score,fill=method))+
  geom_boxplot(outlier.shape = NA)+
  #geom_bar(stat="identity", width = .3,position=position_dodge())+ 
  theme_bw(base_size = 16,base_line_size = .2)

```
# ferritin

```{r}
source('mytheme.R')
df <- read.csv('Data/csv/Ferritin_Like_seq.csv')
df <- df[df$length!=0,]

dis <- read.csv('Data/csv/disTM_vec_Ferritin_Like_seq.csv')
colnames(dis) <- rownames(dis) <- df$pdbID
dis <- 1 - dis
dis <- as.dist(dis)


df2 <- df[with(df, order(df$group)),]
rn <- df2$pdbID
rownames(df2) <- rn
grp <- list(Bacteri     = rn[1:5],
            BMM_alpha = rn[6:7],
            BMM_beta  = rn[8:9],
            Dps  = rn[10:24],
            Fatty_acid  = rn[25:28],
            Ferritins  = rn[29:39],
            RNRR2  = rn[40:47],
            NAA  = rn[48:52])


hc <- dis %>% hclust(method = "ward.D2") 
hc <- ape::bionj(dis)

adjustedRandIndex(cutree(hc, 8), df$group)
classError(cutree(hc, 8), df$group)

p_data <- ggtree(hc,layout = 'dendrogram',
                 branch.length='none',size = 1.5) 

p<-groupOTU(p_data, grp, "groups") + aes(color=groups) +
  theme(#legend.position="none",
        plot.title = element_text(size = 17, hjust = 0.5,vjust = 5))+
  geom_tiplab(aes(label=label,),
               hjust=1,size=3.5,fontface="bold",align=F)
```
